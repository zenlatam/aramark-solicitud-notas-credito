<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous">
    </script>

<script>
    const rootModal = document.getElementById("rootModal");
    let clonModalBody = `        
    
    <div id="spinner-loader" class="spinner-loader">
        <span class="loaderSpinner"></span>
        <h2>Cargando Folios DTE...</h2>
        </div>
    <div id="modal-body" class="modal-body" style="display: none;">
<div id="static-form-container">
    <fw-form id="fw-static-form">
        <div class="tipo-nota-credito">
            <fw-select label="Tipo Nota de Crédito" id="tipo-nota-credito"  value="-"
                placeholder="Tipo nota de Crédito">
                <fw-select-option value="administrativa">Administrativa</fw-select-option>
                <fw-select-option value="operacional">Operacional</fw-select-option>
            </fw-select>
            <div class="tipo-de-venta" id="tipo-de-venta" style="display: none;">
                <fw-select label="Tipo de venta" id="tipo_venta_operacional"  value="-"
                    placeholder="Tipo de venta" required>
                    <fw-select-option value="venta-credito">Por venta Crédito</fw-select-option>
                    <fw-select-option value="venta-contado">Por venta Contado</fw-select-option>
                </fw-select>
            </div>
            <div class="tipo-de-venta" id="tipo-de-venta-administrativa" style="display: none;">
                <fw-select label="Tipo de venta" id="tipo_venta_administrativa"  value="-"
                    placeholder="Tipo de venta" required>
                    <fw-select-option value="venta-credito">Por venta Crédito</fw-select-option>
                    <fw-select-option value="venta-contado">Por venta Contado</fw-select-option>
                </fw-select>
            </div>
        </div>
        <div id="form-administrativa" class="form-administrativa">
            <div class="fw-card-1 section-1">
                <div class="first-row">
                    <fw-input type="NUMBER" name="centro_costo_administrativa" label="Centro de Costo"
                        placeholder="Centro de Costo" id="centro_costo_administrativa" required></fw-input>
                </div>
                <div class="inputs-section">
                    <fw-input type="TEXT" name="nombre" placeholder="Nombre"  label="Nombre"
                        id="nombre-cc-administrativa" disabled></fw-input>
                    <fw-input type="TEXT" name="lob" placeholder="LOB"  label="LOB"
                        id="lob-administrativa" disabled></fw-input>
                    <fw-input type="TEXT" name="cliente" placeholder="Cliente"  label="Cliente"
                        id="cliente-administrativa" disabled></fw-input>
                    <fw-input type="TEXT" name="division" placeholder="Division"
                        label="Division" id="division-administrativa" disabled></fw-input>
                    <fw-input type="TEXT" name="agrupbise" placeholder="Bise"
                        label="Agrup BISE" id="bise-administrativa" disabled></fw-input>
                </div>
            </div>
            <div class="fw-card-1 section-2">
                <div class="first-row" id="folio-input-loaded">
                    <fw-select label="Folio DTE" id="folio-dte-administrativa"  value="-"
                        placeholder="Folio DTE">
                    </fw-select>
                </div>
                <div class="select-spinner" id="folio-spinner">
                    <fw-select label="Folio DTE" id="folio_loading"  value="-"
                        placeholder="Folio DTE" disabled error-text="Cargando Folios DTE..."
                        state="error">
                    </fw-select>
                    <fw-spinner size="medium"></fw-spinner>
                </div>
                <div class="inputs-section">
                    <fw-input disabled type="TEXT" name="rut" placeholder="Rut"  label="Rut"
                        id="rut_administrativa"></fw-input>
                    <fw-input disabled id="monto_neto_administrativa" type="TEXT" name="monto_neto"
                        placeholder="Monto Neto"  label="Monto Neto"></fw-input>
                    <fw-input disabled type="TEXT" name="nombre" placeholder="Nombre"
                        label="Nombre" id="nombre_folio_administrativa"></fw-input>
                    <fw-input disabled type="TEXT" name="fecha_emision" placeholder="Fecha Emision"
                         label="Fecha Emision" id="fecha_emision_administrativa"></fw-input>
                </div>
            </div>
            <div class="fw-card-1">
                <div class="section-administrativa">
                    <fw-input type="TEXT" id="monto-administrativa" name="monto" placeholder="Monto"
                    label="Monto" required></fw-input>
                </div>
                <div class="section-3">
                    <fw-select label="Motivo" id="motivo-administrativa"  value="-"
                        placeholder="Motivo">
                        <fw-select-option value="Administrativa — Reclamo ante el SII">Administrativa — Reclamo ante el SII</fw-select-option>
                        <fw-select-option value="Administrativa — Rechazo del SII">Administrativa — Rechazo del SII</fw-select-option>
                        <fw-select-option value="Administrativa — Cambio de Referencias">Administrativa — Cambio de Referencias</fw-select-option>
                        <fw-select-option value="Administrativa — Error en Digitación">Administrativa — Error en Digitación</fw-select-option>
                        <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                    </fw-select>
                    <fw-textarea rows=5 maxlength=190 minlength=5 name="detalleMotivo"
                        placeholder="Detalle otro Motivo"  label="Detalle Motivo"
                        id="detalle-motivo-administrativa" style="display: none;"></fw-textarea>
                </div>
            </div>
        </div>
        <div id="form-operacional" class="form-operacional" style="display: none;">
            <div class="fw-card-1 section-1">
                <div class="first-row">
                    <fw-input type="NUMBER" name="centro_costo_operacional" label="Centro de Costo"
                        placeholder="Centro de Costo" id="centro_costo_operacional" required></fw-input>
                    <!-- <fw-select label="Centro de costo" id="centro_costo_operacional"
                        value="1" placeholder="Centro de costo">
                        <fw-select-option value="administrativa">Administrativa</fw-select-option>
                        <fw-select-option value="operacional">Operacional</fw-select-option>
                    </fw-select> -->
                </div>
                <div class="inputs-section">
                    <fw-input disabled type="TEXT" name="nombre-cc-operacional" placeholder="Nombre"
                         label="Nombre" id="nombre-cc-operacional"></fw-input>
                    <fw-input disabled type="TEXT" name="lob-operacional" placeholder="LOB"
                        label="LOB" id="lob-operacional"></fw-input>
                    <fw-input disabled type="TEXT" name="cliente-operacional" placeholder="Cliente"
                         label="Cliente" id="cliente-operacional"></fw-input>
                    <fw-input disabled type="TEXT" name="division-operacional" placeholder="Division"
                         label="Division" id="division-operacional"></fw-input>
                    <fw-input disabled type="TEXT" name="bise-operacional" placeholder="Bise"
                        label="Agrup BISE" id="bise-operacional"></fw-input>
                </div>
            </div>
            <div class="fw-card-1 section-2">
                <div class="first-row">
                    <fw-select label="Folio DTE" id="folio_dte_operacional"  value="-" placeholder="Folio DTE"></fw-select>
                </div>
                <div class="inputs-section">
                    <fw-input disabled type="TEXT" name="rut" placeholder="Rut"  label="Rut"
                        id="rut_operacional"></fw-input>
                    <fw-input disabled id="monto_neto_operacional" type="TEXT" name="monto_neto"
                        placeholder="Monto Neto"  label="Monto Neto"></fw-input>
                    <fw-input disabled type="TEXT" name="nombre" placeholder="Nombre"
                        label="Nombre" id="nombre_folio_operacional"></fw-input>
                    <fw-input disabled type="TEXT" name="fecha_emision" placeholder="Fecha Emision"
                         label="Fecha Emision" id="fecha_emision_operacional"></fw-input>
                </div>
            </div>
            <div class="fw-card-1">
                <div id="section-operacional" class="section-operacional inputs-section">
                <fw-select label="Tipo nota de crédito" id="tipo-nc"  value="1"
                    placeholder="Tipo">
                    <fw-select-option value="nc-anulacion">Nota de crédito por Anulación</fw-select-option>
                    <fw-select-option value="nc-rebaja">Nota de crédito por Rebaja</fw-select-option>
                    <fw-select-option value="nc-correccion">Nota de crédito de Corrección</fw-select-option>
                    <fw-select-option value="nc-anula-debito">Anula Nota de Débito</fw-select-option>
                </fw-select>
                <fw-input type="TEXT" id="monto" name="monto" placeholder="Monto"
                    label="Monto" required></fw-input>
            </div>
            <div class="correccion-form" id="correccion-form" style="display: none;">
                <fw-select label="Motivo Corrección" id="motivo-correccion">
                    <fw-select-option value="glosa">Glosa</fw-select-option>
                    <fw-select-option value="direccion">Dirección</fw-select-option>
                    <fw-select-option value="giro">Giro</fw-select-option>
                    <fw-select-option value="comuna">Comuna</fw-select-option>
                    <fw-select-option value="ciudad">Ciudad</fw-select-option>
                </fw-select>
                <div class="inputs-correccion">
                    <fw-input type="TEXT" name="dondedice" placeholder="Donde dice" id="dondedice-input"
                        label="Donde Dice:"></fw-input>
                    <fw-input type="TEXT" name="debedecir" placeholder="Debe decir" id="debedecir-input"
                        label="Debe Decir:"></fw-input>
                </div>
            </div>
            <div class="por-rebaja-form" id="por-rebaja-form" style="display: none;">
                <div class="table-element" style="margin-top: 1rem">
                    <!-- <p id="total">Total Columna 3: 0</p> -->
                    <fw-button color="secondary" id="addRowBtn">Agregar Servicio</fw-button>
                    <table id="dynamicTable">
                        <thead>
                            <tr>
                                <th>Servicio</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Filas serán añadidas aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="section-3">
                <!-- select de nc-anulacion -->
                <fw-select label="Motivo" id="motivo-operacional-anulacion"  value="1"
                    placeholder="Motivo" style="display: none;">
                    <fw-select-option value="operacional - duplicidad de cobro">Operacional - Duplicidad de cobro</fw-select-option>
                    <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en precios</fw-select-option>
                    <fw-select-option value="operacional - cambio de referencias">Operacional - Cambio de referencias</fw-select-option>
                    <fw-select-option value="operacional - cambio en razón social">Operacional - Cambio en razón Social</fw-select-option>
                    <fw-select-option value="operacional - cambio en glosa o descripción">Operacional - Cambio en Glosa o Descripción</fw-select-option>
                    <fw-select-option value="operacional - servicios no entregados">Operacional - Servicios no Entregados</fw-select-option>
                    <fw-select-option value="operacional - iva no recuperable">Operacional - IVA no Recuperable</fw-select-option>
                    <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                </fw-select>

                <!-- select de nc-rebaja -->
                <fw-select label="Motivo" id="motivo-operacional-rebaja"  value="1"
                    placeholder="Motivo" style="display: none;">
                    <fw-select-option value="operacional - duplicidad de cobro">Operacional - Duplicidad de cobro</fw-select-option>
                    <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en precios</fw-select-option>
                    <fw-select-option value="operacional - servicios no entregados">Operacional - Servicios no Entregados</fw-select-option>
                    <fw-select-option value="operacional - iva no recuperable">Operacional - IVA no Recuperable</fw-select-option>
                    <fw-select-option value="operacional - rebaja del servicio">Operacional - Rebaja del Servicio</fw-select-option>
                    <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                </fw-select>

                <!-- select de nc-debito-anulacion -->
                <fw-select label="Motivo" id="motivo-operacional-nc-debito-anulacion"  value="1"
                    placeholder="Motivo" style="display: none;">


                    <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en Precios</fw-select-option>
                    <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                </fw-select>

                <!-- select de por venta contado -->
                <fw-select label="Motivo" id="motivo-operacional-debito-anulacion"
                    value="1" placeholder="Motivo" style="display: none;">
                    <fw-select-option value="operacional - duplicidad de cobro">Operacional - Duplicidad de cobro</fw-select-option>
                    <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en precios</fw-select-option>
                    <fw-select-option value="operacional - cambios de referencias">Operacional - Cambios de referencias</fw-select-option>
                    <fw-select-option value="operacional - cambio en glosa o descripcion">Operacional - Cambio en Glosa o Descripción</fw-select-option>
                    <fw-select-option value="operacional - servicios no entregados">Operacional - Servicios no entregados</fw-select-option>
                    <fw-select-option value="operacional - iva no recuperable">Operacional - IVA no Recuperable</fw-select-option>
                    <fw-select-option value="operacional - rebaja del servicio">Operacional - Rebaja del Servicio</fw-select-option>
                    <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                </fw-select>
                <fw-textarea rows=5 maxlength=190 minlength=5 name="detalleMotivo"
                    placeholder="Detalle otro Motivo"  label="Detalle Motivo"
                    id="detalle-motivo-operacional" style="display: none;"></fw-textarea>
            </div>
        </div>
    </div>
    </fw-form>
    <div class="aprobadores-list" style="margin-top: 1rem; display: none;" id="aprobadores-list">
        <fw-accordion expanded>
            <fw-accordion-title>Aprobadores para esta solicitud</fw-accordion-title>
            <fw-accordion-body>
                <h5>Esta solicitud se enviará a los siguientes aprobadores</h5>
                <ul id="aprobadores-ul">
                </ul>
            </fw-accordion-body>
        </fw-accordion>
    </div>
    <div class="botones-bottom" id="botones-bottom">
        <fw-button color="secondary" id="submit-static-form">Buscar Aprobadores </fw-button>
    </div>
</div>
</div>`
</script>
<script>
    var usuario = "{{user_info.email}}";
    // Get the modal
    var modal = document.getElementById("myModal");
    // Get the button that opens the modal
    var btn = document.getElementById("cc-button");
    // Get the <span> element that closes the modal
    var span = document.getElementById("close-btn-modal");
    // When the user clicks on the button, open the modal
    btn.onclick = function () {
        rootModal.innerHTML = clonModalBody;
        modal.style.display = "block";
        let foliosGlobal = []; // Almacenará todos los folios obtenidos
        let aprobadores;
        let folios;
        let last_request_object;

        main();

    }
    span.onclick = function () {
        modal.style.display = "none";
        rootModal.innerHTML = clonModalBody;
        const newSubmitButton = document.getElementById("submit-static-form");
        newSubmitButton.removeEventListener('fwClick', handleFormInputs);
        window.onload();
    }

    function clearModal() {
        modal.style.display = "none";
        rootModal.innerHTML = clonModalBody;
        const newSubmitButton = document.getElementById("submit-static-form");
        newSubmitButton.removeEventListener('fwClick', handleFormInputs);
        window.onload();
    }
    let foliosGlobal = []; // Almacenará todos los folios obtenidos
    let aprobadores;
    let folios;
    let last_request_object;
    jQuery(window).on('load', function () {
        main();
    });


</script>
<script>


    function main() {
        if (window.jQuery) {
            // jQuery is loaded
            rootModal.innerHTML = clonModalBody;

            const submitButton = document.getElementById("submit-static-form");
            submitButton.addEventListener('fwClick', async (e) => {
                console.log("button Clicked");
                //Se deben realizar validaciones antes de proceder.
                //que el monto sea mayor a cero
                //que los campos obligatorios (FolioDTE y tipo nc) estén llenos.
                const form = document.getElementById("fw-static-form");
                const cc_input = document.getElementById("centro_costo_operacional");
                console.log(cc_input.value);
                handleFormInputs();
            });

            // función que crea opciones para select de folio dte.
            getFoliosDTE().then(response => {
                if (response) {
                    foliosGlobal = response; // Almacena todos los folios obtenidos
                    filterFoliosAndUpdateSelect(); // Actualiza los selectores inicialmente con todos los folios
                }
            });

            const tipoVenta = document.getElementById("tipo_venta_operacional");
            const tipoNC = document.getElementById("tipo-nc");
            const motivoDebitoAnulacion = document.getElementById("motivo-operacional-debito-anulacion");
            const motivoOperacionalDebitoAnulacion = document.getElementById("motivo-operacional-nc-debito-anulacion");
            tipoVenta.addEventListener('fwChange', (e) => {
                console.log(e.detail.value);
                if (e.detail.value == 'venta-credito') {
                    tipoNC.style.display = "block";
                    motivoDebitoAnulacion.style.display = "none";
                }

                else if (e.detail.value != 'venta-credito') {
                    tipoNC.style.display = 'none';
                    console.log("despliegue motivo-debito");
                    motivosOperacionalesVentaCredito.forEach(element => {
                        // console.log(element);
                        element.style.display = "none";
                    });
                    motivoDebitoAnulacion.style.display = "block";
                    tipoNcSelect.value = "";

                    // Creamos y despachamos el evento fwChange
                    const fwChangeEvent = new Event('fwChange', {
                        bubbles: true, // Permite que el evento burbujee
                        cancelable: true // Permite que el evento sea cancelable si es necesario
                    });

                    tipoNcSelect.dispatchEvent(fwChangeEvent);
                }
            });

            // Función para mostrar/ocultar el detalle según el motivo seleccionado
            function handleMotivoChange(motivoElement, detalleElement) {
                motivoElement.addEventListener('fwChange', (e) => {
                    detalleElement.style.display = e.detail.value === 'otro' ? 'block' : 'none';
                });
            }

            // Selección de los elementos y aplicación de la función
            const motivoAdministrativa = document.getElementById("motivo-administrativa");
            const motivoOperacionalAnulacion = document.getElementById("motivo-operacional-anulacion");
            const motivoOperacionalRebaja = document.getElementById("motivo-operacional-rebaja");
            const motivoOperacionalNcDebitoAnulacion = document.getElementById("motivo-operacional-nc-debito-anulacion");
            const motivoOperacionalDebitoAnulacionContado = document.getElementById("motivo-operacional-debito-anulacion");
            const detalleMotivoAdministrativa = document.getElementById("detalle-motivo-administrativa");
            const detalleMotivoOperacional = document.getElementById("detalle-motivo-operacional");

            // HERE
            const motivosOperacionalesVentaCredito = [motivoOperacionalAnulacion, motivoOperacionalRebaja, motivoOperacionalNcDebitoAnulacion, motivoOperacionalDebitoAnulacionContado];

            // Aplicar la misma función a cada par motivo-detalle
            handleMotivoChange(motivoAdministrativa, detalleMotivoAdministrativa);
            handleMotivoChange(motivoOperacionalAnulacion, detalleMotivoOperacional);
            handleMotivoChange(motivoOperacionalRebaja, detalleMotivoOperacional);
            handleMotivoChange(motivoOperacionalDebitoAnulacion, detalleMotivoOperacional);

            //se agrega handle motivo change a operacional contado débito
            handleMotivoChange(motivoOperacionalDebitoAnulacionContado, detalleMotivoOperacional);

            const optionSelect = document.getElementById("tipo-nota-credito");
            optionSelect.addEventListener('fwChange', (e) => {
                const inputTipoVenta = document.getElementById("tipo-de-venta");
                const inputTipoVentaAdministrativa = document.getElementById("tipo-de-venta-administrativa");

                console.log(e.detail.value);
                if (e.detail.value === 'operacional') {
                    inputTipoVenta.style.display = "block";
                    inputTipoVentaAdministrativa.style.display = "none";
                    const formOperacional = document.getElementById("form-operacional");
                    formOperacional.style.display = "block";
                    const formAdministrativa = document.getElementById("form-administrativa");
                    formAdministrativa.style.display = "none";
                }
                else if (e.detail.value === 'administrativa') {
                    inputTipoVentaAdministrativa.style.display = "block";
                    const formAdministrativa = document.getElementById("form-administrativa");
                    formAdministrativa.style.display = "block";
                    const formOperacional = document.getElementById("form-operacional");
                    formOperacional.style.display = "none";
                    inputTipoVenta.style.display = "none";
                }
            });

            //listener tipo-nota-credito
            const tipoNcSelect = document.getElementById("tipo-nc");
            tipoNcSelect.addEventListener('fwChange', (e) => {
                console.log(e.detail.value);
                const correccionForm = document.getElementById("correccion-form");
                const rebajaForm = document.getElementById("por-rebaja-form");
                const selectAnulacion = document.getElementById("motivo-operacional-anulacion");
                const selectRebaja = document.getElementById("motivo-operacional-rebaja");
                let monto = document.getElementById("monto");
                let monto_neto = document.getElementById("monto_neto_operacional").value;
                let tipoVentaVal = document.getElementById("tipo-de-venta").value;
                if (e.detail.value == "nc-correccion") {
                    correccionForm.style.display = "block"
                } else {
                    correccionForm.style.display = "none";

                };

                if (e.detail.value == "nc-rebaja") {
                    rebajaForm.style.display = "block";
                    selectRebaja.style.display = "block";
                    addListenerRowBtn();

                } else {
                    rebajaForm.style.display = "none";
                    selectRebaja.style.display = "none";
                };

                if (e.detail.value == "nc-anulacion") {
                    console.log("desplegar motivo");
                    selectAnulacion.style.display = "block";
                    console.log("hi: ", monto_neto);
                    console.log(monto);
                    monto.value = monto_neto;

                } else {
                    selectAnulacion.style.display = "none";
                };

                if (e.detail.value == "nc-anula-debito") {
                    monto.value = monto_neto;
                    motivoOperacionalDebitoAnulacion.style.display = "block";
                } else {
                    motivoOperacionalDebitoAnulacion.style.display = "none";
                }
            });

            // TO DO: AGREGAR EVENT LISTENER AL cambiar numero de cc
            const inputCentroCostoOperacional = document.getElementById("centro_costo_operacional");
            const inputCentroCostoAdministrativo = document.getElementById("centro_costo_administrativa");
            let debounceTimeout;

            inputCentroCostoOperacional.addEventListener('input', (e) => {
                clearTimeout(debounceTimeout);

                debounceTimeout = setTimeout(async () => {
                    const valorDigitado = e.target.value;
                    if (valorDigitado) {
                        try {
                            let response = await getCentroCosto(valorDigitado);
                            autoFillFieldsOperacional(response.records[0].data);
                            aprobadores = Object.keys(response.records[0].data)
                                .filter(key => key.startsWith('aprobador'))
                                .map(key => response.records[0].data[key]);
                            console.log("aprobadores: ", aprobadores);
                            console.log("valor digitado", valorDigitado);
                            filterFoliosAndUpdateSelect(valorDigitado);
                            inputCentroCostoAdministrativo.state = "normal";
                            inputCentroCostoOperacional.state = "normal";
                        } catch (error) {
                            console.error('Error al obtener centro de costo:', error);
                            inputCentroCostoAdministrativo.setAttribute("error-text", "No se encontró centro de costo.");
                            inputCentroCostoOperacional.setAttribute("error-text", "No se encontró centro de costo.");
                            inputCentroCostoAdministrativo.state = "error";
                            inputCentroCostoOperacional.state = "error";
                        }
                    }
                }, 2000);

            });

            inputCentroCostoAdministrativo.addEventListener('input', (e) => {
                clearTimeout(debounceTimeout);

                debounceTimeout = setTimeout(async () => {
                    const valorDigitado = e.target.value;
                    if (valorDigitado) {
                        try {
                            let response = await getCentroCosto(valorDigitado);
                            autoFillFieldsOperacional(response.records[0].data);
                            console.log("hi", response);
                            aprobadores = Object.keys(response.records[0].data)
                                .filter(key => key.startsWith('aprobador'))
                                .map(key => response.records[0].data[key]);
                            console.log(aprobadores);
                            console.log("valor digitado", valorDigitado);

                            filterFoliosAndUpdateSelect(valorDigitado);
                            inputCentroCostoAdministrativo.state = "normal";
                            inputCentroCostoOperacional.state = "normal";
                        } catch (error) {
                            console.error('Error al obtener centro de costo:', error);
                            inputCentroCostoAdministrativo.setAttribute("error-text", "No se encontró centro de costo.");
                            inputCentroCostoOperacional.setAttribute("error-text", "No se encontró centro de costo.");

                            inputCentroCostoAdministrativo.state = "error";
                            inputCentroCostoOperacional.state = "error";
                        }
                    }
                }, 2000);

            });


            // TODO: AGREGAR EVENT LISTENER AL SELECCIONAR FOLIO
            // Función que maneja el evento 'fwChange'
            const handleFolioChange = (e) => {
                console.log(e.detail.value);
                console.log(foliosGlobal);
                const recordEncontrado = foliosGlobal.find(record => record.data.nro_dte === e.detail.value);
                console.log("record encontrado: ", recordEncontrado);
                autoFillFieldsFolio(recordEncontrado);
            };

            // Obtener los elementos
            const selectFolioAD = document.getElementById("folio-dte-administrativa");
            const selectFolioOP = document.getElementById("folio_dte_operacional");

            // Agregar event listener reutilizando la función
            selectFolioAD.addEventListener('fwChange', handleFolioChange);
            selectFolioOP.addEventListener('fwChange', handleFolioChange);
        } else {
            // jQuery is not loaded
            console.log("Doesn't Work");
        }
    }


    async function enviarRequest(request) {
        const myHeaders = new Headers({
            "Content-Type": "application/json",
            "Authorization": "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY"
        });

        const raw = JSON.stringify(request);

        const requestOptions = {
            method: "POST",
            headers: myHeaders,
            body: raw,
            redirect: "follow"
        };

        try {
            const response = await fetch("https://aramark-hr.freshservice.com/api/v2/service_catalog/items/394/place_request", requestOptions);

            if (!response.ok) {
                const errorMessage = await response.text();
                throw new Error(`Error: ${response.status} - ${errorMessage} `);
            }

            const result = await response.json();
            console.log(result);
        } catch (error) {
            console.error('Error al enviar la solicitud:', error);
        }
    }

    async function getCentroCosto(id_cc) {
        try {
            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

            const requestOptions = {
                method: "GET",
                headers: myHeaders,
                redirect: "follow"
            };

            const response = await fetch(`https://aramark-hr.freshservice.com/api/v2/objects/21000039591/records?query=id_cc%20%3A%20%27${id_cc}%27`, requestOptions);

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();
            console.log(result);
            return result;

        } catch (error) {
            console.error('Error fetching centro de costo:', error);
        }
    }

    async function getFoliosDTE() {
        let allRecords = [];
        let nextPageLink = null; // Inicialmente no hay token para la siguiente página
        const baseUrl = `https://aramark-hr.freshservice.com/api/v2/objects/21000039592/records`;

        showFoliosLoader();

        try {
            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

            const requestOptions = {
                method: "GET",
                headers: myHeaders,
                redirect: "follow"
            };

            do {
                const url = nextPageLink
                    ? `${baseUrl}?next_page_link=${encodeURIComponent(nextPageLink)}`
                    : `${baseUrl}?page_size=100`;

                const response = await fetch(url, requestOptions);

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.records && Array.isArray(result.records)) {
                    allRecords = allRecords.concat(result.records);
                }

                nextPageLink = result.next_page_link || null;
            } while (nextPageLink);

            return allRecords;
        } catch (error) {
            console.error('Error al obtener los folios DTE:', error);
            return [];
        } finally {
            hideFoliosLoader();
        }
    }


    // Función para filtrar y actualizar los selectores según el ccosto
    function filterFoliosAndUpdateSelect(value) {
        console.log("Input de centro de costo recibido:", value);
        console.log("foliosGlobal:", foliosGlobal);

        // Validar que foliosGlobal sea un array
        if (!Array.isArray(foliosGlobal)) {
            console.error("foliosGlobal no es un array válido:", foliosGlobal);
            return;
        }

        // Asegurarse de que value sea un string limpio para la comparación
        const cc_value = String(value).trim();

        // Filtrar los folios
        const filteredFolios = cc_value
            ? foliosGlobal.filter(folio => {
                // console.log("Compare this: ", folio);
                // console.log(`Comparando: ${folio.data.ccosto} === ${cc_value}`);
                return String(folio.data.ccosto).trim() === cc_value;
            })
            : foliosGlobal; // Si value está vacío, no filtrar

        // Generar opciones para los selectores
        const optionsObject = createSelectOptionsObject(filteredFolios);

        const folioSelectAd = document.getElementById("folio-dte-administrativa");
        const folioSelectOp = document.getElementById("folio_dte_operacional");

        // Asignar las opciones filtradas
        folioSelectAd.options = optionsObject;
        folioSelectOp.options = optionsObject;

        console.log(`Actualizados los selectores con ${filteredFolios.length} folios.`);
    }


    async function getAprobadorId(email) {
        try {
            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

            const requestOptions = {
                method: "GET",
                headers: myHeaders,
                redirect: "follow"
            };

            const response = await fetch(`https://aramark-hr.freshservice.com/api/v2/requesters?email=${email}`, requestOptions);

            if (!response.ok) {
                throw new Error(`Error ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result && result.requesters && result.requesters.length > 0) {
                const aprobador = result.requesters[0]; // Accediendo al primer solicitante
                console.log(aprobador.id);
                return aprobador.id; // Devolviendo el ID del solicitante
            } else {
                throw new Error('No se encontró ningún aprobador con ese email.');
            }

        } catch (error) {
            console.error('Error fetching requester:', error);
        }
    }


    function showFoliosLoader() {
        const spinnerElement = document.getElementById("folio-spinner");
        spinnerElement.style.display = "flex";
        const folioLoaded = document.getElementById("folio-input-loaded");
        folioLoaded.style.display = "none";
    };

    function hideFoliosLoader() {
        const spinnerDiv = document.getElementById("spinner-loader");
        const spinnerElement = document.getElementById("folio-spinner");
        spinnerElement.style.display = "none";
        spinnerDiv.style.display = "none";
        const folioLoaded = document.getElementById("folio-input-loaded");
        folioLoaded.style.display = "grid";
        const modalBody = document.getElementById("modal-body").style.display = "block";
    };

    function agregarAprobadoresAListaHTML(aprobadoresAsignados, aprobadoresListElement) {
        aprobadoresListElement.innerHTML = "";

        for (const key in aprobadoresAsignados) {
            if (aprobadoresAsignados.hasOwnProperty(key)) {
                aprobadoresListElement.innerHTML += `<li>${aprobadoresAsignados[key]}</li>`;
            }
        }
    }


    function createSelectOptionsObject(data) {
        console.log("DATA CREATESELECTOBJ: ", data);
        let newDataSource = [];
        data.forEach(element => {
            let obj = {
                "value": element.data.nro_dte,
                "text": element.data.nro_dte
            };

            newDataSource.push(obj);
        });
        return newDataSource;
    }

    function autoFillFieldsFolio(record) {
        if (record) {
            //campos a llenar
            document.getElementById("rut_administrativa").value = record.data.rut;
            document.getElementById("rut_operacional").value = record.data.rut;
            document.getElementById("monto_neto_operacional").value = record.data.neto;
            document.getElementById("monto_neto_administrativa").value = record.data.neto;
            document.getElementById("nombre_folio_operacional").value = record.data.razon_social;
            document.getElementById("nombre_folio_administrativa").value = record.data.razon_social;
            document.getElementById("fecha_emision_administrativa").value = record.data.fecha_transaccion;
            document.getElementById("fecha_emision_operacional").value = record.data.fecha_transaccion;
        }
    };

    function autoFillFieldsOperacional(response) {
        console.log("response: ", response);

        document.getElementById("nombre-cc-operacional").value = response.name_cc;
        document.getElementById("lob-operacional").value = response.lob;
        document.getElementById("cliente-operacional").value = response.client;
        document.getElementById("division-operacional").value = response.division;
        document.getElementById("bise-operacional").value = response.agrup_bise;
        document.getElementById("nombre-cc-administrativa").value = response.name_cc;
        document.getElementById("lob-administrativa").value = response.lob;
        document.getElementById("cliente-administrativa").value = response.client;
        document.getElementById("division-administrativa").value = response.division;
        document.getElementById("bise-administrativa").value = response.agrup_bise;
    }

    // funct   ion autoFillFieldsAdministrativa(response) {
    //     c onsole.log("response: ", response);
    //     d    ocument.getElementById("nombre-cc-administrativa").value = response.name_cc;
    //     d       ocument.getElementById("lob-administrativa").value = response.lob;
    //     d     ocument.getElementById("cliente-administrativa").value = response.client;
    //         document.getElementById("division-administrativa").value = response.division;
    //     document.getElementById("bise-administrativa").value = response.agrup_bise;
    // }


    //Script tabla

    function addListenerRowBtn() {
        const btn_AddRow = document.getElementById("addRowBtn");

        function addNewRow() {
            console.log("*********************************** HI");
            let table = document.getElementById("dynamicTable").getElementsByTagName('tbody')[0];
            let newRow = table.insertRow();
            let fila = table.rows.length;

            for (let i = 0; i < 3; i++) {
                let newCell = newRow.insertCell(i);
                let input = document.createElement("input");
                input.type = "text";

                if (i === 2) {
                    input.id = `precio-${fila}`;
                    input.value = `0`;
                    input.type = "number";
                } else if (i === 1) {
                    input.id = `cantidad-${fila}`;
                    input.value = `1`;
                    input.type = "number";
                } else if (i === 0) {
                    input.id = `servicio-${fila}`;
                    input.value = `Servicio ${fila}`;
                }
                newCell.appendChild(input);
            }

            let precioInput = document.getElementById(`precio-${fila}`);
            let cantidadInput = document.getElementById(`cantidad-${fila}`);

            precioInput.addEventListener('keyup', (e) => {
                console.log(e.target.value);
                calcularTotal();
            });

            cantidadInput.addEventListener('keyup', (e) => {
                console.log(e.target.value);
                calcularTotal();
            });
            // Crear botón de eliminación
            let actionCell = newRow.insertCell(3);
            let deleteBtn = document.createElement("fw-button");
            deleteBtn.setAttribute("color", "secondary");
            deleteBtn.textContent = "Eliminar";
            deleteBtn.addEventListener("click", function () {
                table.deleteRow(newRow.rowIndex - 1); // Eliminar la fila correspondiente
                calcularTotal();
            });
            actionCell.appendChild(deleteBtn);

            calcularTotal();
        }

        btn_AddRow.removeEventListener('fwClick', addNewRow)
        btn_AddRow.addEventListener("fwClick", addNewRow);
    }

    function calcularTotal() {
        let total = 0;
        const table = document.getElementById("dynamicTable").getElementsByTagName('tbody')[0];
        for (let i = 0; i < table.rows.length; i++) {
            const cantidadValue = table.rows[i].cells[1].getElementsByTagName("input")[0].value;
            const precioValue = table.rows[i].cells[2].getElementsByTagName("input")[0].value;

            const cantidad = parseFloat(cantidadValue) || 0;
            const precio = parseFloat(precioValue) || 0;

            total += cantidad * precio;
        }
        // document.getElementById("total").textContent = "Total Columna 3: " + total;
        document.getElementById("monto").value = total;
    }

    function asignarAprobadores(monto, aprobadores) {
        // Remover punto       s del valor de monto y convertirlo a número
        monto = parseInt(monto.replace(/\./g, ''), 10);

        let cantidadAprobadores;

        if (monto < 3000000) {
            console.log("Esta solicitud requiere 1 aprobador");
            cantidadAprobadores = 1;
        } else if (monto < 10000000) {
            console.log("Esta solicitud requiere 2 aprobadores");
            cantidadAprobadores = 2;
        } else if (monto < 15000000) {
            console.log("Esta solicitud requiere 3 aprobadores");
            cantidadAprobadores = 3;
        } else if (monto < 20000000) {
            console.log("Esta solicitud requiere 4 aprobadores");
            cantidadAprobadores = 4;
        } else {
            console.log("Esta solicitud requiere 5 aprobadores");
            cantidadAprobadores = 5;
        }

        const aprobadoresRequeridos = {};
        for (let i = 0; i < cantidadAprobadores; i++) {
            console.log("no debería aparecer: ", aprobadores[i]);
            aprobadoresRequeridos[`aprobador_${i + 1}`] = aprobadores[i + 2];
        }

        if (monto >= 20000000) {
            console.log("Esta solicitud requiere aprobación de CFO");
            aprobadoresRequeridos["aprobador_5"] = "guzman-jaime@aramark.cl"
        }

        return aprobadoresRequeridos;
    }


    function removeFirstTwoAprobadores(obj) {
        const keys = Object.keys(obj).filter(key => key.startsWith("aprobador"));

        // Eliminar los dos primeros aprobadores
        if (keys.length >= 2) {
            delete obj[keys[0]];
            delete obj[keys[1]];
        }
    }

    async function handleFormInputs() {
        // Captura de datos de formulario operacional.
        console.log("handleFormInputs");
        console.log("***************>>>>>");
        let tipo_de_nota_de_credito = document.getElementById("tipo-nota-credito").value;
        console.log(tipo_de_nota_de_credito);

        // const outerFormHtml = document.getElementById("fw-static-form").outerHTML;

        if (tipo_de_nota_de_credito === 'operacional') {
            console.log("success");
            let tipo_de_venta = document.getElementById("tipo_venta_operacional").value;
            let centro_de_costo = document.getElementById("centro_costo_operacional").value;
            let cliente = document.getElementById("cliente-operacional").value;
            let agrup_bise = document.getElementById("bise-operacional").value;
            let lob = document.getElementById("lob-operacional").value;
            let division = document.getElementById("division-operacional").value;
            let folio_dte = document.getElementById("folio_dte_operacional").value;
            let rut = document.getElementById("rut_operacional").value;
            let nombre = document.getElementById("nombre_folio_operacional").value;
            let monto_neto = document.getElementById("monto_neto_operacional").value;
            let fecha_emision = document.getElementById("fecha_emision_operacional").value;
            let tipo_nota_credito = document.getElementById("tipo-nota-credito").value;
            let monto = document.getElementById("monto").value;
            let detalle_otro_motivo = document.getElementById("detalle-motivo-operacional").value;
            let aprobadores_list = document.getElementById("aprobadores-ul");
            let aprobadores_accordeon = document.getElementById("aprobadores-list");
            let tipoNotaCredito = document.getElementById("tipo-nc").value;


            const monto_operacional = document.getElementById("monto").value;
            const monto_administrativa = document.getElementById("monto-administrativa").value;

            if (tipo_de_venta === '-') {
                Swal.fire({
                    title: "Error en el tipo de venta",
                    text: "El campo de tipo de venta está vacío o no es válido.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            }

            if (rut === '') {
                Swal.fire({
                    title: "Error datos obtenidos de DTE",
                    text: "Alguno de los campos de este DTE no es válido o no se seleccionó un DTE correctamente.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            };

            // Validación de los montos
            if (monto_operacional === '' ||
                isNaN(parseInt(monto_operacional.replace(/\./g, ''))) ||
                parseInt(monto_operacional.replace(/\./g, '')) <= 0) {
                Swal.fire({
                    title: "Error en el monto operacional",
                    text: "El campo de monto operacional está vacío o no es un número válido.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            }
            else if (centro_de_costo == '' || isNaN(centro_de_costo)) {
                Swal.fire({
                    title: "Error en el Centro de Costo",
                    text: "El campo de centro de costo está vacío o no es un número válido.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            }
            const jefeFacturacion = "mateluna-jenifer@aramark.cl";

            let aprobadoresAsignados = asignarAprobadores(monto_neto, aprobadores);

            if (tipoNotaCredito == 'nc-correccion') {
                console.log(">>>>>> nota corrección <<<<<<");
                aprobadoresAsignados = {
                    aprobador_1: jefeFacturacion
                };
            }
            // Asignar aprobadores



            // quitar dos primeros aprobadores



            agregarAprobadoresAListaHTML(aprobadoresAsignados, aprobadores_list);


            // Crear el objeto de campos personalizados dinámicamente
            const customFields = {
                "tipo_de_nota_de_credito": tipo_de_nota_de_credito,
                "tipo_de_venta": tipo_de_venta,
                "centro_de_costo": centro_de_costo,
                "cliente": cliente,
                "agrup_bise": agrup_bise,
                "lob": lob,
                "division": division,
                "folio_dte": folio_dte,
                "rut": rut,
                "nombre": nombre,
                "monto_neto": monto_neto,
                "fecha_emision": fecha_emision,
                "tipo": tipo_nota_credito,
                "monto": monto

            };
            if (detalle_otro_motivo) customFields.detalle_otro_motivo = detalle_otro_motivo;

            // Obtener los IDs de los aprobadores y agregarlos si existen
            const aprobador_1_id = await getAprobadorId(aprobadoresAsignados.aprobador_1);
            if (aprobador_1_id) customFields.aprobador_1 = aprobador_1_id;

            const aprobador_2_id = aprobadoresAsignados.aprobador_2 ? await getAprobadorId(aprobadoresAsignados.aprobador_2) : null;
            if (aprobador_2_id) customFields.aprobador_2 = aprobador_2_id;

            const aprobador_3_id = aprobadoresAsignados.aprobador_3 ? await getAprobadorId(aprobadoresAsignados.aprobador_3) : null;
            if (aprobador_3_id) customFields.aprobador_3 = aprobador_3_id;

            const aprobador_4_id = aprobadoresAsignados.aprobador_4 ? await getAprobadorId(aprobadoresAsignados.aprobador_4) : null;
            if (aprobador_4_id) customFields.aprobador_4 = aprobador_4_id;

            const aprobador_5_id = aprobadoresAsignados.aprobador_5 ? await getAprobadorId(aprobadoresAsignados.aprobador_5) : null;
            if (aprobador_5_id) customFields.aprobador_5 = aprobador_5_id;

            const aprobador_6_id = aprobadoresAsignados.aprobador_6 ? await getAprobadorId(aprobadoresAsignados.aprobador_6) : null;
            if (aprobador_6_id) customFields.aprobador_6 = aprobador_6_id;

            const requestObject = {
                "email": usuario,
                "quantity": 1,
                "custom_fields": customFields
            };

            console.log(requestObject);
            aprobadores_accordeon.style.display = "block";

            const botonesBottom = document.getElementById("botones-bottom");
            botonesBottom.innerHTML = `
                    <fw-button color="secondary" id="submit-static-form">Buscar Aprobadores </fw-button>
                        <fw-button id="send-form">Enviar</fw-button>
    
                        `

            last_request_object = requestObject;
            const enviarButton = document.getElementById("send-form");
            enviarButton.removeEventListener('fwClick', enviarRequest);

            enviarButton.addEventListener('fwClick', async (e) => {
                console.log("*************", last_request_object);
                console.log("***** clear modal *****");
                console.log("***** swal ******");


                // if (monto_administrativa === '' || isNaN(monto_administrativa)) {
                //     Swal.fire({
                //         title: "Error en el monto administrativa",
                //         text: "El campo de monto administrativa está vacío o no es un número válido.",
                //         icon: "error"
                //     });
                //     return; // Detiene la ejecución si no pasa la validación
                // }

                try {
                    let response = await enviarRequest(last_request_object);
                    clearModal();
                    Swal.fire({
                        title: "¡Envío exitoso!!",
                        text: "¡Se ha enviado su solicitud correctamente!",
                        icon: "success"
                    });

                } catch (error) {
                    console.error('Error al enviar request:', error);
                }
            });

        } else if (tipo_de_nota_de_credito === 'administrativa') {
            // Captura de datos de administrativa
            let tipo_venta_administrativa = document.getElementById("tipo_venta_administrativa").value;
            let centro_de_costo = document.getElementById("centro_costo_administrativa").value;
            let cliente = document.getElementById("cliente-administrativa").value;
            let agrup_bise = document.getElementById("bise-administrativa").value;
            let lob = document.getElementById("lob-administrativa").value;
            let division = document.getElementById("division-administrativa").value;
            let folio_dte = document.getElementById("folio-dte-administrativa").value;
            let rut = document.getElementById("rut_administrativa").value;
            let nombre = document.getElementById("nombre_folio_administrativa").value;
            let monto_neto = document.getElementById("monto_neto_administrativa").value;
            let fecha_emision = document.getElementById("fecha_emision_administrativa").value;
            let monto = document.getElementById("monto-administrativa").value;
            let motivo = document.getElementById("motivo-administrativa").value;
            let detalle_otro_motivo = document.getElementById("detalle-motivo-administrativa").value;
            let aprobadores_list = document.getElementById("aprobadores-ul");
            let aprobadores_accordeon = document.getElementById("aprobadores-list");

            // Asignar aprobadores
            // const aprobadoresAsignados = asignarAprobadores(monto_neto, aprobadores);

            const jefeFacturacion = "mateluna-jenifer@aramark.cl";


            //En NC Administrativas el aprobador debe ser el jefe de facturación
            const aprobadoresAsignados = {
                aprobador_1: jefeFacturacion
            };

            const monto_operacional = document.getElementById("monto").value;
            const monto_administrativa = document.getElementById("monto-administrativa").value;
            const centro_costo_administrativa = document.getElementById("centro_costo_administrativa").value;


            if (tipo_venta_administrativa === '-') {
                Swal.fire({
                    title: "Error en el tipo de venta",
                    text: "El campo de tipo de venta está vacío o no es válido.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            }


            if (rut === '') {
                Swal.fire({
                    title: "Error datos obtenidos de DTE",
                    text: "Alguno de los campos de este DTE no es válido o no se seleccionó un DTE correctamente.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            };


            // Validación de los montos
            if (monto_administrativa === '' || isNaN(parseInt(monto_administrativa.replace(/\./g, '')))) {
                Swal.fire({
                    title: "Error en el monto administrativo",
                    text: "El campo de Monto de tipo de nota de crédito administrativa está vacío o no es un número válido.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            }
            else if (centro_costo_administrativa == '' || isNaN(parseInt(centro_costo_administrativa.replace(/\./g, '')))) {
                Swal.fire({
                    title: "Error en el Centro de Costo",
                    text: "El campo de centro de costo está vacío o no es un número válido.",
                    icon: "error"
                });
                return; // Detiene la ejecución si no pasa la validación
            }


            agregarAprobadoresAListaHTML(aprobadoresAsignados, aprobadores_list);


            // Crear el objeto de campos personalizados dinámicamente
            const customFields = {
                "tipo_de_nota_de_credito": tipo_de_nota_de_credito,
                "tipo_de_venta": tipo_venta_administrativa,
                "centro_de_costo": centro_de_costo,
                "cliente": cliente,
                "agrup_bise": agrup_bise,
                "lob": lob,
                "division": division,
                "folio_dte": folio_dte,
                "rut": rut,
                "nombre": nombre,
                "monto_neto": monto_neto,
                "fecha_emision": fecha_emision,
                "monto": monto,
                "motivo": motivo
            };

            if (detalle_otro_motivo) customFields.detalle_otro_motivo = detalle_otro_motivo;
            // Obtener los IDs de los aprobadores y agregarlos si existen
            const aprobador_1_id = await getAprobadorId(aprobadoresAsignados.aprobador_1);
            if (aprobador_1_id) customFields.aprobador_1 = aprobador_1_id;

            const aprobador_2_id = aprobadoresAsignados.aprobador_2 ? await getAprobadorId(aprobadoresAsignados.aprobador_2) : null;
            if (aprobador_2_id) customFields.aprobador_2 = aprobador_2_id;

            const aprobador_3_id = aprobadoresAsignados.aprobador_3 ? await getAprobadorId(aprobadoresAsignados.aprobador_3) : null;
            if (aprobador_3_id) customFields.aprobador_3 = aprobador_3_id;

            const aprobador_4_id = aprobadoresAsignados.aprobador_4 ? await getAprobadorId(aprobadoresAsignados.aprobador_4) : null;
            if (aprobador_4_id) customFields.aprobador_4 = aprobador_4_id;

            const aprobador_5_id = aprobadoresAsignados.aprobador_5 ? await getAprobadorId(aprobadoresAsignados.aprobador_5) : null;
            if (aprobador_5_id) customFields.aprobador_5 = aprobador_5_id;

            const aprobador_6_id = aprobadoresAsignados.aprobador_6 ? await getAprobadorId(aprobadoresAsignados.aprobador_6) : null;
            if (aprobador_6_id) customFields.aprobador_6 = aprobador_6_id;

            const requestObject = {
                "email": usuario,
                "quantity": 1,
                "custom_fields": customFields
            };

            console.log(requestObject);
            aprobadores_accordeon.style.display = "block";
            last_request_object = requestObject;
        }

        const botonesBottom = document.getElementById("botones-bottom");
        botonesBottom.innerHTML = `
                        <fw-button color="secondary" id="submit-static-form">Buscar Aprobadores </fw-button>
                        <fw-button id="send-form">Enviar</fw-button>
    
                        `

        const enviarButton = document.getElementById("send-form");
        enviarButton.removeEventListener('fwClick', enviarRequest);

        enviarButton.addEventListener('fwClick', async (e) => {
            console.log("*************", last_request_object);

            const monto_operacional = document.getElementById("monto").value;
            const monto_administrativa = document.getElementById("monto-administrativa").value;

            // Validación de los montos

            // if (monto_operacional === '' || isNaN(parseInt(monto_operacional.replace(/\./g, '')))) {
            //     Swal.fire({
            //         title: "Error en el monto operacional",
            //         text: "El campo de monto operacional está vacío o no es un número válido.",
            //         icon: "error"
            //     });
            //     return; // Detiene la ejecución si no pasa la validación
            // }

            // if (monto_administrativa === '' || isNaN(parseInt(monto_administrativa.replace(/\./g, '')))) {
            //     Swal.fire({
            //         title: "Error en el monto administrativa",
            //         text: "El campo de monto administrativa está vacío o no es un número válido.",
            //         icon: "error"
            //     });
            //     return; // Detiene la ejecución si no pasa la validación
            // }

            try {
                let response = await enviarRequest(last_request_object);
                clearModal();
                Swal.fire({
                    title: "¡Envío exitoso!!",
                    text: "¡Se ha enviado su solicitud correctamente!",
                    icon: "success"
                });

            } catch (error) {
                console.error('Error al enviar request:', error);
            }
        });
    }
</script>
<style>
    .hero-banner-container strong,
    .portal-name {
        text-shadow: 0 0 14px #000000, 0 0 14px #000000;
    }
</style>

<section id="home-page-container" data-ce-version="2.1">
    <section id="hero-banner" data-ce="true" data-ce-id="hero-banner" data-ce-type="section" data-ce-subtype="hero"
        data-ce-template-name="home">
        <div class="hero-banner-container">
            <h2 data-ce-translation="portal.home_title" data-ce-id="heroTitle" data-ce="true" data-ce-content="static"
                data-ce-type="text" data-placeholder="{{translate 'portal.builder.enter_your_text'}}">
                <strong>{{customTranslate "portal.home_title"}}</strong>
            </h2>
            <section id="banner-search">
                <form role='search' id="search-form">
                    <i class="ficon-search" role="presentation"></i>
                    <input type="search" id="global-search-home" class="search-input"
                        aria-label="{{ translate 'portal.search.search_text'}}"
                        placeholder="{{translate 'portal.home_search_placeholder'}}" />
                </form>
            </section>
            <section id="announcement-banner" role="region" aria-label="{{translate 'portal.announcements'}}">
                {{#announcement}}
                <div class="announcement-banner-container">
                    <a class="announcement-link" href="/support/announcements/{{id}}">
                        <div class="announcement-latest">
                            <div class="announcement-postedby-img">
                                {{avatar name=user.name url=user.avatar_url class="user-profile-pic"}}
                            </div>
                            <div class="announcement-content">
                                <h2 class="announcement-title">{{title}}</h2>
                                <p class="announcement-postedby">{{{ translate "portal.announcements_sidebar.posted_by"
                                    user_name=user.name created_on=(timediff planned_start_date) }}}</p>
                            </div>
                        </div>
                    </a>
                    <div class="announcement-show-all">
                        <a class="announcement-show-all-link" href="/support/announcements">
                            {{translate "portal.view_all"}}
                        </a>
                    </div>
                </div>
                {{/announcement}}
            </section>
        </div>
    </section>


    <section>
        <div class="section-aramark">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cc-button"></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="rrhh-tab" data-bs-toggle="tab" data-bs-target="#rrhh-tab-pane"
                        type="button" role="tab" aria-controls="rrhh-tab-pane" aria-expanded="false"
                        aria-selected="false"></button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="supply-tab" data-bs-toggle="tab" data-bs-target="#supply-tab-pane"
                        type="button" role="ta b" aria-controls="supply-tab-pane" aria-selected="false"></button>
                </li>
            </ul>
            <div class="tab-content" id="myTabContent" style="padding-bottom: 5rem;">
                <div class="tab-pane fade show" id="rrhh-tab-pane" role="tabpanel" aria-labelledby="rrhh-tab"
                    tabindex="0">
                    <div class="tab-content">
                        <!-- CÓDIGO EDITABLE DE TARJETAS, EDITAR DESCRIPCIONES/SRC DE IMÁGENES. -->
                        <div class="tab-flex" style="padding: 2rem;">
                            <a class="btn-aramark text-center" data-bs-toggle="collapse" onclick='scrollButton()'
                                href="#collapseSolicitarFormularios" role="button" aria-expanded="false"
                                aria-controls="collapseSolicitarFormularios">
                                <img src="https://i.postimg.cc/Z5N8hrjv/Buscar-Formulario.png" alt="">
                                <h6><b>Buscar Formulario</b></h6>
                                <div class="descripcion-img">En el catálogo de servicios disponible, selecciónalo y
                                    envía la solicitud.</div>
                            </a>
                            <a class="btn-aramark text-center" href="https://cs.aramark.cl/support/approvals/pending">
                                <img src="https://i.postimg.cc/MHXB3RvT/Aprobar-Solicitudes.png" alt="">
                                <h6><b>Gestionar Solicitudes</b></h6>
                                <div class="descripcion-img">Si eres Jefe, JOP o GOP, aprueba o rechaza solicitudes
                                    para darle continuidad al proceso.</div>
                            </a>
                            <a class="btn-aramark text-center" href="https://cs.aramark.cl/support/tickets/new">
                                <img src="https://i.postimg.cc/sXx13zyH/Reportar-problemas.png" alt="">
                                <h6><b>Reportar Problema</b></h6>
                                <div class="descripcion-img">Completa el formulario con toda la información
                                    necesaria para poder resolverlo en tiempo y forma.</div>
                            </a>
                            <a class="btn-aramark text-center" data-bs-toggle="collapse" href="#collapsePreguntas"
                                role="button" aria-expanded="false" aria-controls="collapsePreguntas"
                                onclick='scrollButton()'>
                                <img src="https://i.postimg.cc/Gp5T8tMn/Preguntas-Frecuentes-Gral.png" alt="">
                                <h6><b>Preguntas frecuentes</b></h6>
                                <div class="descripcion-img">Ingresa una palabra clave para tu consulta (Ej.
                                    Vacaciones, Pagos, etc.) y la base de conocimiento devolverá los mejores
                                    resultados.</div>
                            </a>
                        </div>
                        <div class="collapse" id="collapsePreguntas" data-bs-parent="#rrhh-collapse-group">
                            <div class="container">
                                <div class="row d-flex justify-content-center">
                                    <div class="col-3 card mx-3">
                                        <a class="card-pais text-center"
                                            href="https://cs.aramark.cl/support/solutions/21000068969">
                                            <img class="mw-100"
                                                src="https://i.postimg.cc/MTfp5gCb/Preguntas-Frecuentes-CL.png" alt="">
                                            <h6><b>Chile</b></h6>
                                        </a>
                                    </div>
                                    <div class="col-3 card mx-3">
                                        <a class="card-pais text-center"
                                            href="https://cs.aramark.cl/support/solutions/21000049845">
                                            <img class="mw-100"
                                                src="https://i.postimg.cc/J79Bf5Kz/Preguntas-Frecuentes-ARG.png" alt="">
                                            <h6><b>Argentina</b></h6>
                                        </a>
                                    </div>
                                    <div class="col-3 card mx-3">
                                        <a class="card-pais text-center"
                                            href="https://cs.aramark.cl/support/solutions/21000066583">
                                            <img class="mw-100"
                                                src="https://i.postimg.cc/nzShGpSL/Preguntas-Frecuentes-MEX.png" alt="">
                                            <h6><b>México</b></h6>
                                        </a>
                                    </div>

                                </div>
                            </div>
                        </div>
                        <div class="collapse" id="collapseSolicitarFormularios" data-bs-parent="#rrhh-collapse-group">
                            <div class="container">
                                <div class="row d-flex justify-content-center">

                                    <div class="col-3 card m-3">
                                        <a class="card-pais text-center"
                                            href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000272780">
                                            <img src="https://i.postimg.cc/9FLSJzcV/Sistemas-de-recursos-humanos.png"
                                                alt="">
                                            <h6><b>Sistemas de Recursos Humanos</b></h6>
                                        </a>
                                    </div>

                                    <div class="col-3 card m-3">
                                        <a class="card-pais text-center"
                                            href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000275317">
                                            <img src="https://i.postimg.cc/dVm6tVVp/Tramites-personales.png" alt="">
                                            <h6><b>Trámites Personales</b></h6>
                                        </a>
                                    </div>

                                    <div class="col-3 card m-3">
                                        <a class="card-pais text-center"
                                            href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000275318">
                                            <img src="https://i.postimg.cc/Kv7Btshg/Bienestar.png" alt="">
                                            <h6><b>Bienestar</b></h6>
                                        </a>
                                    </div>

                                    <div class="col-3 card m-3">
                                        <a class="card-pais text-center"
                                            href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000280223">
                                            <img src="https://i.postimg.cc/ZKVPY1wH/Asistencia-Social.png" alt="">
                                            <h6><b>Asistencia Social</b></h6>
                                        </a>
                                    </div>

                                    <div class="col-3 card m-3">
                                        <a class="card-pais text-center"
                                            href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000275322">
                                            <img src="https://i.postimg.cc/x89HnRHB/Gestion-Personas.png" alt="">
                                            <h6><b>Gestión de Personas</b></h6>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <div class="tab-pane fade" id="supply-tab-pane" role="tabpanel" aria-labelledby="supply-tab" tabindex="0">
                <div class="tab-content">
                    <div id="supply-collapse-group">
                        <div class="tab-flex" style="padding: 2rem;">
                            <!-- <a class="btn-aramark" data-bs-toggle="collapse" href="#collapseExample" role="button"
          aria-expanded="false" aria-controls="collapseExample">
          Requerimientos
        </a> -->
                            <div class="col-3 card">
                                <a class="card-pais text-center"
                                    href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000275520">
                                    <img src="https://i.postimg.cc/Ssk4cT58/Generar-Requerimiento.png" alt="">
                                    <h6><b>Generar Requerimientos</b></h6>
                                    <div class="descripcion-img">Seleccione el formulario de la categoría y complete
                                        los datos solicitados para su requerimiento.</div>
                                </a>
                            </div>
                            <!--    <a class="btn-aramark" data-bs-toggle="collapse" href="#collapseReclamos" role="button"
           ar   ia-expanded="false" aria-controls="collapseReclamos">
            Re  clamos
           </a> -->
                            <div class="col-3 card">
                                <a class="card-pais text-center"
                                    href="https://aramark-hr.freshservice.com/support/catalog/items?category_id=21000274118">
                                    <img src="https://i.postimg.cc/sXx13zyH/Reportar-problemas.png" alt="">
                                    <h6><b>Reportar Incidencias</b></h6>
                                    <div class="descripcion-img">Complete el formulario de incidencias, con toda la
                                        información necesaria para poder resolverlo en tiempo y forma.</div>
                                </a>
                            </div>
                            <!--   <a class="btn-aramark" data-bs-toggle="collapse" href="#collapseOtras" role="button"
              aria-expanded="false" aria-controls="collapseOtras">
          Otras Solicitudes
            </a> -->
                            <div class="col-3 card">
                                <a class="card-pais text-center"
                                    href="https://cs.aramark.cl/a/solutions/categories/21000070790">
                                    <img src="https://i.postimg.cc/Gp5T8tMn/Preguntas-Frecuentes-Gral.png" alt="">
                                    <h6><b>Preguntas frecuentes</b></h6>
                                    <div class="descripcion-img">Recorra las preguntas frecuentes por categorías y
                                        aclara todas tus dudas.</div>
                                </a>
                            </div>
                        </div>
                        <div class="collapse" id="collapseExample" data-bs-parent="#supply-collapse-group">
                            <div class="card card-body">
                                Requerimientos
                            </div>
                        </div>
                        <div class="collapse" id="collapseReclamos" data-bs-parent="#supply-collapse-group">
                            <div class="card card-body">
                                Reclamos
                            </div>
                        </div>
                        <div class="collapse" id="collapseOtras" data-bs-parent="#supply-collapse-group">
                            <div class="card card-body">
                                Otras
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section style="display: none;" id="cards-banner" class="banner-{{cards.length}}" data-ce="true"
        data-ce-type="section" data-ce-subtype="cards" data-ce-id="cards-banner" data-ce-template-name="home">
        {{#each cards}}
        <a href="{{url}}" class="card" {{conditional_attribute external_image 'target' '_blank' }} data-ce="true"
            data-ce-type="card" data-ce-subtype="default" data-ce-template-name="home" data-ce-children-editable="true"
            data-ce-id={{ternary ceId ceId (concat "default-card-" (toString @index))}}>
            {{image src=img alt="" role="presentation" class="elem-inline-mid"}}
            <div class="elem-inline-mid card-text">
                <h3 data-ce-translation="{{titleTranslationPath}}">
                    {{title}}
                    {{#if external_image}}
                    {{image src="/images/portal_v2/open-in-new-tab.svg" alt=(translate "portal.aria.external")
                    class="external-link"}}
                    {{/if}}
                </h3>
                <p data-ce-translation="{{contentTranslationPath}}">
                    {{content}}
                </p>
            </div>
        </a>
        {{/each}}
    </section>

    {{#if portal.logged_in}}
    <section id="home-lists-container" class="list-container" data-ce="true" data-ce-type="section" data
        -ce-subtype="tickets" data-ce-id="home-lists-container" data-ce-template-name="home">
        {{> loader}}
    </section>
    {{/if}}
</section>

<div id="myModal" class="modal">
    <!-- Mod    al content -->
    <div class="modal-content">
        <span id="close-btn-modal" class="close">&times;</span>
        <div class="modal-element">
            <div class="modal-toolbar">
                <div class="modal-title"></div>
                <div class="close-btn"></div>
                <div id="rootModal">
                </div>
            </div>
        </div>
    </div>
</div>