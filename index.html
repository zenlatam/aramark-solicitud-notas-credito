<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    body {
        margin: 10rem;
    }

    .inputs-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .botones-bottom {
        margin: 1rem 0;
    }

    /* Estilos tabla */
    table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
    }


    th {
        /* border: 1px solid black; */
        background-color: rgb(245, 247, 249);
        color: rgb(71, 88, 103);
    }

    tr {
        border-block-end: 1px solid rgb(235, 239, 243);
    }

    th,
    td {
        padding: 10px;
        text-align: left;
    }

    input {
        width: 100%;
        box-sizing: border-box;
        padding: 5px;
        border: 1px solid rgb(207, 215, 223);
        border-radius: 5px;
    }

    button {
        margin-top: 10px;
    }


    .tipo-nota-credito {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .inputs-correccion {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .first-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    #tipo-nc {
        display: none;
    }

    .select-spinner {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .select-spinner fw-select {
        width: 45%;
    }

    .select-spinner fw-spinner {
        margin-top: .5rem;
    }


    /* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content/Box */
.modal-content {
  background-color: #fefefe;
  margin: 15% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 80%; /* Could be more or less, depending on screen size */
}

/* The Close Button */
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}
</style>

<body>


    <button id="myBtn">Open Modal</button>
    
    <!-- The Modal -->
    <div id="myModal" class="modal">
    
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>Some text in the Modal..</p>
            <div class="modal-element">
                <div class="modal-toolbar">
                    <div class="modal-title"></div>
                    <div class="close-btn"></div>
        
                    <div class="modal-body">
        
                        <div id="static-form-container">
                            <fw-form id="fw-static-form">
                                <div class="tipo-nota-credito">
                                    <fw-select label="Tipo Nota de Crédito" id="tipo-nota-credito" required="true" value="1"
                                        placeholder="Tipo nota de Crédito">
        
                                        <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                        <fw-select-option value="operacional">Operacional</fw-select-option>
                                    </fw-select>
        
        
                                    <div class="tipo-de-venta" id="tipo-de-venta" style="display: none;">
                                        <fw-select label="Tipo de venta" id="tipo_venta_operacional" required="true" value="1"
                                            placeholder="Tipo de venta">
        
                                            <fw-select-option value="venta-credito">Por venta Crédito</fw-select-option>
                                            <fw-select-option value="venta-contado">Por venta Contado</fw-select-option>
                                        </fw-select>
                                    </div>
                                </div>
        
                                <div id="form-administrativa" class="form-administrativa">
                                    <div class="section-1">
                                        <div class="first-row">
                                            <fw-input type="NUMBER" name="centro_costo_administrativa" label="Centro de Costo"
                                                placeholder="Centro de Costo" id="centro_costo_administrativa"></fw-input>
                                        </div>
                                        <div class="inputs-section">
                                            <fw-input type="TEXT" name="nombre" placeholder="Nombre" required label="Nombre"
                                                id="nombre-cc-administrativa" disabled></fw-input>
                                            <fw-input type="TEXT" name="lob" placeholder="LOB" required label="LOB"
                                                id="lob-administrativa" disabled></fw-input>
                                            <fw-input type="TEXT" name="cliente" placeholder="Cliente" required label="Cliente"
                                                id="cliente-administrativa" disabled></fw-input>
                                            <fw-input type="TEXT" name="division" placeholder="Division" required
                                                label="Division" id="division-administrativa" disabled></fw-input>
                                            <fw-input type="TEXT" name="agrupbise" placeholder="Bise" required
                                                label="Agrup BISE" id="bise-administrativa" disabled></fw-input>
                                        </div>
                                    </div>
        
                                    <div class="section-2">
                                        <div class="first-row" id="folio-input-loaded">
                                            <fw-select label="Folio DTE" id="folio-dte-administrativa" required="true" value="1"
                                                placeholder="Folio DTE">
                                            </fw-select>
                                        </div>
                                        <div class="select-spinner" id="folio-spinner">
        
                                            <fw-select label="Folio DTE" id="folio_loading" required="true" value="1"
                                                placeholder="Folio DTE" disabled error-text="Cargando Folios DTE..."
                                                state="error">
                                            </fw-select>
                                            <fw-spinner size="medium"></fw-spinner>
                                        </div>
        
                                        <div class="inputs-section">
                                            <fw-input disabled type="TEXT" name="rut" placeholder="Rut" required label="Rut"
                                                id="rut_administrativa"></fw-input>
        
                                            <fw-input disabled id="monto_neto_administrativa" type="TEXT" name="monto_neto"
                                                placeholder="Monto Neto" required label="Monto Neto"></fw-input>
        
                                            <fw-input disabled type="TEXT" name="nombre" placeholder="Nombre" required
                                                label="Nombre" id="nombre_folio_administrativa"></fw-input>
        
                                            <fw-input disabled type="TEXT" name="fecha_emision" placeholder="Fecha Emision"
                                                required label="Fecha Emision" id="fecha_emision_administrativa"></fw-input>
                                        </div>
        
        
        
                                    </div>
        
                                    <div class="section-3">
                                        <fw-select label="Motivo" id="motivo-administrativa" required="true" value="1"
                                            placeholder="Motivo">
        
                                            <fw-select-option value="Administrativa — Reclamo ante el SII">Administrativa — Reclamo ante el SII</fw-select-option>
                                            <fw-select-option value="Administrativa — Rechazo del SII">Administrativa — Rechazodel SII</fw-select-option>
                                            <fw-select-option value="Administrativa — Cambio de Referencias">Administrativa — Cambio de Referencias</fw-select-option>
                                            <fw-select-option value="Administrativa — Error en Digitación">Administrativa — Error en Digitación</fw-select-option>
                                            <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                                        </fw-select>
                                        <fw-textarea rows=5 maxlength=190 minlength=5 name="detalleMotivo"
                                            placeholder="Detalle otro Motivo" required label="Detalle Motivo"
                                            id="detalle-motivo-administrativa" style="display: none;"></fw-textarea>
                                    </div>
        
                                </div>
        
        
        
                                <div id="form-operacional" class="form-operacional" style="display: none;">
        
                                    <div class="section-1">
                                        <div class="first-row">
                                            <fw-input type="NUMBER" name="centro_costo_operacional" label="Centro de Costo"
                                                placeholder="Centro de Costo" id="centro_costo_operacional"></fw-input>
                                            <!-- <fw-select label="Centro de costo" id="centro_costo_operacional" required="true"
                                                value="1" placeholder="Centro de costo">
            
                                                <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                                <fw-select-option value="operacional">Operacional</fw-select-option>
                                            </fw-select> -->
                                        </div>
                                        <div class="inputs-section">
                                            <fw-input disabled type="TEXT" name="nombre-cc-operacional" placeholder="Nombre"
                                                required label="Nombre" id="nombre-cc-operacional"></fw-input>
                                            <fw-input disabled type="TEXT" name="lob-operacional" placeholder="LOB" required
                                                label="LOB" id="lob-operacional"></fw-input>
                                            <fw-input disabled type="TEXT" name="cliente-operacional" placeholder="Cliente"
                                                required label="Cliente" id="cliente-operacional"></fw-input>
                                            <fw-input disabled type="TEXT" name="division-operacional" placeholder="Division"
                                                required label="Division" id="division-operacional"></fw-input>
                                            <fw-input disabled type="TEXT" name="bise-operacional" placeholder="Bise" required
                                                label="Agrup BISE" id="bise-operacional"></fw-input>
                                        </div>
                                    </div>
        
                                    <div class="section-2">
                                        <div class="first-row">
                                            <fw-select label="Folio DTE" id="folio_dte_operacional" required="true" value="1"
                                                placeholder="Folio DTE">
        
                                            </fw-select>
                                        </div>
        
                                        <div class="inputs-section">
                                            <fw-input disabled type="TEXT" name="rut" placeholder="Rut" required label="Rut"
                                                id="rut_operacional"></fw-input>
        
                                            <fw-input disabled id="monto_neto_operacional" type="TEXT" name="monto_neto"
                                                placeholder="Monto Neto" required label="Monto Neto"></fw-input>
        
                                            <fw-input disabled type="TEXT" name="nombre" placeholder="Nombre" required
                                                label="Nombre" id="nombre_folio_operacional"></fw-input>
        
                                            <fw-input disabled type="TEXT" name="fecha_emision" placeholder="Fecha Emision"
                                                required label="Fecha Emision" id="fecha_emision_operacional"></fw-input>
                                        </div>
        
        
        
                                    </div>
        
                                    <div id="section-operacional" class="section-operacional inputs-section">
        
                                        <fw-select label="Tipo nota de crédito" id="tipo-nc" required="true" value="1"
                                            placeholder="Tipo">
        
                                            <fw-select-option value="nc-anulacion">Nota de crédito por Anulación</fw-select-option>
                                            <fw-select-option value="nc-rebaja">Nota de crédito por Rebaja</fw-select-option>
                                            <fw-select-option value="nc-correccion">Nota de crédito de Corrección</fw-select-option>
                                            <fw-select-option value="nc-anula-debito">Anula Nota de Débito</fw-select-option>
                                        </fw-select>
        
        
                                        <fw-input type="TEXT" id="monto" name="monto" placeholder="Monto" required
                                            label="Monto"></fw-input>
        
        
                                    </div>
        
                                    <div class="correccion-form" id="correccion-form" style="display: none;">
                                        <fw-select label="Motivo Corrección" id="motivo-correccion">
                                            <fw-select-option value="glosa">Glosa</fw-select-option>
                                            <fw-select-option value="direccion">Dirección</fw-select-option>
                                            <fw-select-option value="giro">Giro</fw-select-option>
                                            <fw-select-option value="comuna">Comuna</fw-select-option>
                                            <fw-select-option value="ciudad">Ciudad</fw-select-option>
                                        </fw-select>
                                        <div class="inputs-correccion">
                                            <fw-input type="TEXT" name="dondedice" placeholder="Donde dice" id="dondedice-input"
                                                label="Donde Dice:"></fw-input>
                                            <fw-input type="TEXT" name="debedecir" placeholder="Debe decir" id="debedecir-input"
                                                label="Debe Decir:"></fw-input>
                                        </div>
        
                                    </div>
        
                                    <div class="por-rebaja-form" id="por-rebaja-form" style="display: none;">
        
                                        <div class="table-element">
        
                                            <!-- <p id="total">Total Columna 3: 0</p> -->
        
                                            <button id="addRowBtn">Agregar Fila</button>
        
                                            <table id="dynamicTable">
                                                <thead>
                                                    <tr>
                                                        <th>Servicio</th>
                                                        <th>Cantidad</th>
                                                        <th>Precio Unitario</th>
                                                        <th>Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Filas serán añadidas aquí -->
                                                </tbody>
                                            </table>
        
                                        </div>
                                    </div>
        
                                    <div class="section-3">
                                        <!-- select de nc-anulacion -->
                                        <fw-select label="Motivo" id="motivo-operacional-anulacion" required="true" value="1"
                                            placeholder="Motivo" style="display: none;">
        
        
                                            <fw-select-option value="operacional - duplicidad de cobro">Operacional - Duplicidad de cobro</fw-select-option>
                                            <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en precios</fw-select-option>
                                            <fw-select-option value="operacional - cambio de referencias">Operacional - Cambio de referencias</fw-select-option>
                                            <fw-select-option value="operacional - cambio en razón social">Operacional - Cambio en razón Social</fw-select-option>
                                            <fw-select-option value="operacional - cambio en glosa o descripción">Operacional - Cambio en Glosa o Descripción</fw-select-option>
                                            <fw-select-option value="operacional - servicios no entregados">Operacional - Servicios no Entregados</fw-select-option>
                                            <fw-select-option value="operacional - iva no recuperable">Operacional - IVA no Recuperable</fw-select-option>
                                            <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                                        </fw-select>
        
                                        <!-- select de nc-rebaja -->
                                        <fw-select label="Motivo" id="motivo-operacional-rebaja" required="true" value="1"
                                            placeholder="Motivo" style="display: none;">
        
        
                                            <fw-select-option value="operacional - duplicidad de cobro">Operacional - Duplicidad de cobro</fw-select-option>
                                            <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en precios</fw-select-option>
                                            <fw-select-option value="operacional - servicios no entregados">Operacional - Servicios no Entregados</fw-select-option>
                                            <fw-select-option value="operacional - iva no recuperable">Operacional - IVA no Recuperable</fw-select-option>
                                            <fw-select-option value="operacional - rebaja del servicio">Operacional - Rebaja del Servicio</fw-select-option>
                                            <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                                        </fw-select>
        
                                        <!-- select de nc-debito-anulación -->
                                        <fw-select label="Motivo" id="motivo-operacional-debito-anulacion" required="true"
                                            value="1" placeholder="Motivo" style="display: none;">
        
        
                                            <fw-select-option value="operacional - duplicidad de cobro">Operacional - Duplicidad de cobro</fw-select-option>
                                            <fw-select-option value="operacional - diferencias en precios">Operacional - Diferencias en precios</fw-select-option>
                                            <fw-select-option value="operacional - cambios de referencias">Operacional - Cambios de referencias</fw-select-option>
                                            <fw-select-option value="operacional - cambio en glosa o descripcion">Operacional - Cambio en Glosa o Descripción</fw-select-option>
                                            <fw-select-option value="operacional - servicios no entregados">Operacional - Servicios no entregados</fw-select-option>
                                            <fw-select-option value="operacional - iva no recuperable">Operacional - IVA no Recuperable</fw-select-option>
                                            <fw-select-option value="operacional - rebaja del servicio">Operacional - Rebaja del Servicio</fw-select-option>
                                            <fw-select-option value="otro">Otro (Especificar)</fw-select-option>
                                        </fw-select>
                                        <fw-textarea rows=5 maxlength=190 minlength=5 name="detalleMotivo"
                                            placeholder="Detalle otro Motivo" required label="Detalle Motivo"
                                            id="detalle-motivo-operacional" style="display: none;"></fw-textarea>
                                    </div>
        
                                </div>
        
        
        
                            </fw-form>
        
                            <div class="aprobadores-list" style="margin-top: 1rem; display: none;" id="aprobadores-list">
                                <fw-accordion expanded>
                                    <fw-accordion-title>Aprobadores para esta solicitud</fw-accordion-title>
                                    <fw-accordion-body>
                                        <h2>Esta solicitud se enviará a los siguientes aprobadores</h2>
                                        <ul id="aprobadores-ul">
                                        </ul>
                                    </fw-accordion-body>
                                </fw-accordion>
        
                            </div>
        
        
        
                            <div class="botones-bottom">
        
                                <fw-button id="submit-static-form">Buscar Aprobadores </fw-button>
                                <fw-button id="reset-static-form">Cancelar</fw-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    
    </div>




    



    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>


    <script>

    // Get the modal
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal
    var btn = document.getElementById("myBtn");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    btn.onclick = function () {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }





        let aprobadores;
        let folios;
        //listener de primer select tipo nota crédito
        document.addEventListener('DOMContentLoaded', () => {

            const submitButton = document.getElementById("submit-static-form");
            submitButton.addEventListener('fwClick', async (e) => {
                console.log("button Clicked");

                const form = document.getElementById("fw-static-form");

                const cc_input = document.getElementById("centro_costo_operacional");
                console.log(cc_input.value);

                handleFormInputs();

            });

            // función que crea opciones para select de folio dte.
            getFoliosDTE().then(
                response => {
                    hideFoliosLoader();
                    if (response) {
                        folios = response;
                        const optionsObject = createSelectOptionsObject(folios);
                        console.log("OPTIONS OBJECT: ", optionsObject);
                        const folioSelectAd = document.getElementById("folio-dte-administrativa");
                        const folioSelectOp = document.getElementById("folio_dte_operacional");
                        folioSelectAd.options = optionsObject;
                        folioSelectOp.options = optionsObject;
                    }
                }
            );

            const tipoVenta = document.getElementById("tipo_venta_operacional");
            const tipoNC = document.getElementById("tipo-nc");
            const motivoDebitoAnulacion = document.getElementById("motivo-operacional-debito-anulacion");
            tipoVenta.addEventListener('fwChange', (e) => {
                console.log(e.detail.value);
                if (e.detail.value == 'venta-credito') {
                    tipoNC.style.display = "block";
                    motivoDebitoAnulacion.style.display = "none";
                }

                else if (e.detail.value != 'venta-credito') {
                    tipoNC.style.display = 'none';
                    console.log("despliegue motivo-debito");
                    motivoDebitoAnulacion.style.display = "block";
                }
            });

            // Función para mostrar/ocultar el detalle según el motivo seleccionado
            function handleMotivoChange(motivoElement, detalleElement) {
                motivoElement.addEventListener('fwChange', (e) => {
                    detalleElement.style.display = e.detail.value === 'otro' ? 'block' : 'none';
                });
            }

            // Selección de los elementos y aplicación de la función
            const motivoAdministrativa = document.getElementById("motivo-administrativa");
            const detalleMotivoAdministrativa = document.getElementById("detalle-motivo-administrativa");

            const motivoOperacionalAnulacion = document.getElementById("motivo-operacional-anulacion");
            const detalleMotivoOperacional = document.getElementById("detalle-motivo-operacional");

            const motivoOperacionalRebaja = document.getElementById("motivo-operacional-rebaja");

            // Aplicar la misma función a cada par motivo-detalle
            handleMotivoChange(motivoAdministrativa, detalleMotivoAdministrativa);
            handleMotivoChange(motivoOperacionalAnulacion, detalleMotivoOperacional);
            handleMotivoChange(motivoOperacionalRebaja, detalleMotivoOperacional);



            const optionSelect = document.getElementById("tipo-nota-credito");
            optionSelect.addEventListener('fwChange', (e) => {
                console.log(e.detail.value);
                if (e.detail.value === 'operacional') {
                    const inputTipoVenta = document.getElementById("tipo-de-venta");
                    inputTipoVenta.style.display = "block";
                    const formOperacional = document.getElementById("form-operacional");
                    formOperacional.style.display = "block";
                    const formAdministrativa = document.getElementById("form-administrativa");
                    formAdministrativa.style.display = "none";
                }
                else if (e.detail.value === 'administrativa') {
                    const formAdministrativa = document.getElementById("form-administrativa");
                    formAdministrativa.style.display = "block";
                    const formOperacional = document.getElementById("form-operacional");
                    formOperacional.style.display = "none";
                    const inputTipoVenta = document.getElementById("tipo-de-venta");
                    inputTipoVenta.style.display = "none";
                }
            });

            //listener tipo-nota-credito
            const tipoNcSelect = document.getElementById("tipo-nc");
            tipoNcSelect.addEventListener('fwChange', (e) => {
                console.log(e.detail.value);
                const correccionForm = document.getElementById("correccion-form");
                const rebajaForm = document.getElementById("por-rebaja-form");
                const selectAnulacion = document.getElementById("motivo-operacional-anulacion");
                const selectRebaja = document.getElementById("motivo-operacional-rebaja");
                let monto = document.getElementById("monto");
                let monto_neto = document.getElementById("monto_neto_operacional").value;
                let tipoVentaVal = document.getElementById("tipo-de-venta").value;
                if (e.detail.value == "nc-correccion") {
                    correccionForm.style.display = "block"
                } else {
                    correccionForm.style.display = "none";

                };

                if (e.detail.value == "nc-rebaja") {
                    rebajaForm.style.display = "block";
                    selectRebaja.style.display = "block";
                } else {
                    rebajaForm.style.display = "none";
                    selectRebaja.style.display = "none";
                };

                if (e.detail.value == "nc-anulacion") {
                    console.log("desplegar motivo");
                    selectAnulacion.style.display = "block";
                    console.log("hi: ", monto_neto);
                    console.log(monto);
                    monto.value = monto_neto;

                } else {
                    selectAnulacion.style.display = "none";
                };
            });

            // TO DO: AGREGAR EVENT LISTENER AL cambiar numero de cc    
            const inputCentroCostoOperacional = document.getElementById("centro_costo_operacional");
            const inputCentroCostoAdministrativo = document.getElementById("centro_costo_administrativa");
            let debounceTimeout;

            inputCentroCostoOperacional.addEventListener('input', (e) => {
                clearTimeout(debounceTimeout);

                debounceTimeout = setTimeout(async () => {
                    const valorDigitado = e.target.value;
                    if (valorDigitado) {
                        try {
                            let response = await getCentroCosto(valorDigitado);
                            autoFillFieldsOperacional(response.records[0].data);
                            console.log("hi");
                            aprobadores = Object.keys(response.records[0].data)
                                .filter(key => key.startsWith('aprobador'))
                                .map(key => response.records[0].data[key]);
                            console.log("aprobadores: ", aprobadores);
                        } catch (error) {
                            console.error('Error al obtener centro de costo:', error);
                        }
                    }
                }, 2000);

            });

            inputCentroCostoAdministrativo.addEventListener('input', (e) => {
                clearTimeout(debounceTimeout);

                debounceTimeout = setTimeout(async () => {
                    const valorDigitado = e.target.value;
                    if (valorDigitado) {
                        try {
                            let response = await getCentroCosto(valorDigitado);
                            autoFillFieldsOperacional(response.records[0].data);
                            console.log("hi", response);
                            aprobadores = Object.keys(response.records[0].data)
                                .filter(key => key.startsWith('aprobador'))
                                .map(key => response.records[0].data[key]);
                            console.log(aprobadores);
                        } catch (error) {
                            console.error('Error al obtener centro de costo:', error);
                        }
                    }
                }, 2000);

            });


            // TODO: AGREGAR EVENT LISTENER AL SELECCIONAR FOLIO
            // Función que maneja el evento 'fwChange'
            const handleFolioChange = (e) => {
                console.log(e.detail.value);
                console.log(folios);
                const recordEncontrado = folios.records.find(record => record.data.nro_dte === e.detail.value);
                console.log("record encontrado: ", recordEncontrado);
                autoFillFieldsFolio(recordEncontrado);
            };



            // Obtener los elementos
            const selectFolioAD = document.getElementById("folio-dte-administrativa");
            const selectFolioOP = document.getElementById("folio_dte_operacional");

            // Agregar event listener reutilizando la función
            selectFolioAD.addEventListener('fwChange', handleFolioChange);
            selectFolioOP.addEventListener('fwChange', handleFolioChange);

        });





        async function getCentroCosto(id_cc) {
            try {
                const myHeaders = new Headers();
                myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

                const requestOptions = {
                    method: "GET",
                    headers: myHeaders,
                    redirect: "follow"
                };

                const response = await fetch(`https://aramark-hr.freshservice.com/api/v2/objects/21000039591/records?query=id_cc%20%3A%20%27${id_cc}%27`, requestOptions);

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log(result);
                return result;

            } catch (error) {
                console.error('Error fetching centro de costo:', error);
            }
        }


        async function getFoliosDTE() {
            showFoliosLoader();
            try {
                const myHeaders = new Headers();
                myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

                const requestOptions = {
                    method: "GET",
                    headers: myHeaders,
                    redirect: "follow"
                };

                //https://aramark-hr.freshservice.com/api/v2/objects/21000039592/records?query=nro_dte%20%3A%20%27687716%27
                const response = await fetch(`https://aramark-hr.freshservice.com/api/v2/objects/21000039592/records`, requestOptions);

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                console.log(result);
                return result;

            } catch (error) {
                console.error('Error fetching folios DTE:', error);
            }
        }
        async function getAprobadorId(email) {
            try {
                const myHeaders = new Headers();
                myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

                const requestOptions = {
                    method: "GET",
                    headers: myHeaders,
                    redirect: "follow"
                };

                const response = await fetch(`https://aramark-hr.freshservice.com/api/v2/requesters?email=${email}`, requestOptions);

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result && result.requesters && result.requesters.length > 0) {
                    const aprobador = result.requesters[0]; // Accediendo al primer solicitante
                    console.log(aprobador.id);
                    return aprobador.id; // Devolviendo el ID del solicitante
                } else {
                    throw new Error('No se encontró ningún aprobador con ese email.');
                }

            } catch (error) {
                console.error('Error fetching requester:', error);
            }
        }


        function showFoliosLoader() {
            const spinnerElement = document.getElementById("folio-spinner");
            spinnerElement.style.display = "flex";
            const folioLoaded = document.getElementById("folio-input-loaded");
            folioLoaded.style.display = "none";
        };

        function hideFoliosLoader() {
            const spinnerElement = document.getElementById("folio-spinner");
            spinnerElement.style.display = "none";
            const folioLoaded = document.getElementById("folio-input-loaded");
            folioLoaded.style.display = "grid";
        };

        function agregarAprobadoresAListaHTML(aprobadoresAsignados, aprobadoresListElement) {
            aprobadoresListElement.innerHTML = "";

            for (const key in aprobadoresAsignados) {
                if (aprobadoresAsignados.hasOwnProperty(key)) {
                    aprobadoresListElement.innerHTML += `<li>${aprobadoresAsignados[key]}</li>`;
                }
            }
        }


        function createSelectOptionsObject(data) {
            console.log("DATA CREATESELECTOBJ: ", data);
            let newDataSource = [];
            data.records.forEach(element => {
                let obj = {
                    "value": element.data.nro_dte,
                    "text": element.data.nro_dte
                };

                newDataSource.push(obj);
            });
            return newDataSource;
        }

        function autoFillFieldsFolio(record) {
            //campos a llenar
            document.getElementById("rut_administrativa").value = record.data.rut;
            document.getElementById("rut_operacional").value = record.data.rut;
            document.getElementById("monto_neto_operacional").value = record.data.neto;
            document.getElementById("monto_neto_administrativa").value = record.data.neto;
            document.getElementById("nombre_folio_operacional").value = record.data.razon_social;
            document.getElementById("nombre_folio_administrativa").value = record.data.razon_social;
            document.getElementById("fecha_emision_administrativa").value = record.data.fecha_transaccion;
            document.getElementById("fecha_emision_operacional").value = record.data.fecha_transaccion;

        };

        function autoFillFieldsOperacional(response) {
            console.log("response: ", response);

            document.getElementById("nombre-cc-operacional").value = response.name_cc;
            document.getElementById("lob-operacional").value = response.lob;
            document.getElementById("cliente-operacional").value = response.client;
            document.getElementById("division-operacional").value = response.division;
            document.getElementById("bise-operacional").value = response.agrup_bise;
            document.getElementById("nombre-cc-administrativa").value = response.name_cc;
            document.getElementById("lob-administrativa").value = response.lob;
            document.getElementById("cliente-administrativa").value = response.client;
            document.getElementById("division-administrativa").value = response.division;
            document.getElementById("bise-administrativa").value = response.agrup_bise;
        }

        // function autoFillFieldsAdministrativa(response) {
        //     console.log("response: ", response);
        //     document.getElementById("nombre-cc-administrativa").value = response.name_cc;
        //     document.getElementById("lob-administrativa").value = response.lob;
        //     document.getElementById("cliente-administrativa").value = response.client;
        //     document.getElementById("division-administrativa").value = response.division;
        //     document.getElementById("bise-administrativa").value = response.agrup_bise;
        // }


        //Script tabla



        document.getElementById("addRowBtn").addEventListener("click", function () {
            let table = document.getElementById("dynamicTable").getElementsByTagName('tbody')[0];
            let newRow = table.insertRow();
            let fila = table.rows.length;

            for (let i = 0; i < 3; i++) {
                let newCell = newRow.insertCell(i);
                let input = document.createElement("input");
                input.type = "text";

                if (i === 2) {
                    input.id = `precio-${fila}`;
                    input.value = `0`;
                } else if (i === 1) {
                    input.id = `cantidad-${fila}`;
                    input.value = `1`;
                } else if (i === 0) {
                    input.id = `servicio-${fila}`;
                    input.value = `Servicio ${fila}`;
                }



                newCell.appendChild(input);


            }

            let precioInput = document.getElementById(`precio-${fila}`);
            let cantidadInput = document.getElementById(`cantidad-${fila}`);

            precioInput.addEventListener('keyup', (e) => {
                console.log(e.target.value);
                calcularTotal();
            });

            cantidadInput.addEventListener('keyup', (e) => {
                console.log(e.target.value);
                calcularTotal();
            });
            // Crear botón de eliminación
            let actionCell = newRow.insertCell(3);
            let deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Eliminar";
            deleteBtn.addEventListener("click", function () {
                table.deleteRow(newRow.rowIndex - 1); // Eliminar la fila correspondiente
                calcularTotal();
            });
            actionCell.appendChild(deleteBtn);

            calcularTotal();
        });



        function calcularTotal() {
            let total = 0;
            const table = document.getElementById("dynamicTable").getElementsByTagName('tbody')[0];
            for (let i = 0; i < table.rows.length; i++) {
                const cantidadValue = table.rows[i].cells[1].getElementsByTagName("input")[0].value;
                const precioValue = table.rows[i].cells[2].getElementsByTagName("input")[0].value;

                const cantidad = parseFloat(cantidadValue) || 0;
                const precio = parseFloat(precioValue) || 0;

                total += cantidad * precio;
            }
            // document.getElementById("total").textContent = "Total Columna 3: " + total;
            document.getElementById("monto").value = total;
        }

        function asignarAprobadores(monto, aprobadores) {
            // Remover puntos del valor de monto y convertirlo a número
            monto = parseInt(monto.replace(/\./g, ''), 10);

            let cantidadAprobadores;

            if (monto < 3000000) {
                console.log("Esta solicitud requiere 1 aprobador");
                cantidadAprobadores = 1;
            } else if (monto < 10000000) {
                console.log("Esta solicitud requiere 2 aprobadores");
                cantidadAprobadores = 2;
            } else if (monto < 15000000) {
                console.log("Esta solicitud requiere 3 aprobadores");
                cantidadAprobadores = 3;
            } else if (monto < 20000000) {
                console.log("Esta solicitud requiere 4 aprobadores");
                cantidadAprobadores = 4;
            } else {
                console.log("Esta solicitud requiere 5 aprobadores");
                cantidadAprobadores = 5;
            }

            const aprobadoresRequeridos = {};
            for (let i = 0; i < cantidadAprobadores; i++) {
                aprobadoresRequeridos[`aprobador_${i + 1}`] = aprobadores[i];
            }

            return aprobadoresRequeridos;
        }

        async function handleFormInputs() {
            // Captura de datos de formulario operacional.
            console.log("handleFormInputs");

            let tipo_de_nota_de_credito = document.getElementById("tipo-nota-credito").value;
            console.log(tipo_de_nota_de_credito);

            if (tipo_de_nota_de_credito === 'operacional') {
                console.log("success");
                let tipo_de_venta = document.getElementById("tipo_venta_operacional").value;
                let centro_de_costo = document.getElementById("centro_costo_operacional").value;
                let cliente = document.getElementById("cliente-operacional").value;
                let agrup_bise = document.getElementById("bise-operacional").value;
                let lob = document.getElementById("lob-operacional").value;
                let division = document.getElementById("division-operacional").value;
                let folio_dte = document.getElementById("folio_dte_operacional").value;
                let rut = document.getElementById("rut_operacional").value;
                let nombre = document.getElementById("nombre_folio_operacional").value;
                let monto_neto = document.getElementById("monto_neto_operacional").value;
                let fecha_emision = document.getElementById("fecha_emision_operacional").value;
                let tipo_nota_credito = document.getElementById("tipo-nota-credito").value;
                let monto = document.getElementById("monto").value;
                let detalle_otro_motivo = document.getElementById("detalle-motivo-operacional").value;
                let aprobadores_list = document.getElementById("aprobadores-ul");
                let aprobadores_accordeon = document.getElementById("aprobadores-list");


                // Asignar aprobadores
                const aprobadoresAsignados = asignarAprobadores(monto_neto, aprobadores);
                agregarAprobadoresAListaHTML(aprobadoresAsignados, aprobadores_list);


                // Crear el objeto de campos personalizados dinámicamente
                const customFields = {
                    "tipo_de_nota_de_credito": tipo_de_nota_de_credito,
                    "tipo_de_venta": tipo_de_venta,
                    "centro_de_costo": centro_de_costo,
                    "cliente": cliente,
                    "agrup_bise": agrup_bise,
                    "lob": lob,
                    "division": division,
                    "folio_dte": folio_dte,
                    "rut": rut,
                    "nombre": nombre,
                    "monto_neto": monto_neto,
                    "fecha_emision": fecha_emision,
                    "tipo": tipo_nota_credito,
                    "monto": monto

                };
                if (detalle_otro_motivo) customFields.detalle_otro_motivo = detalle_otro_motivo;

                // Obtener los IDs de los aprobadores y agregarlos si existen
                const aprobador_1_id = await getAprobadorId(aprobadoresAsignados.aprobador_1);
                if (aprobador_1_id) customFields.aprobador_1 = aprobador_1_id;

                const aprobador_2_id = aprobadoresAsignados.aprobador_2 ? await getAprobadorId(aprobadoresAsignados.aprobador_2) : null;
                if (aprobador_2_id) customFields.aprobador_2 = aprobador_2_id;

                const aprobador_3_id = aprobadoresAsignados.aprobador_3 ? await getAprobadorId(aprobadoresAsignados.aprobador_3) : null;
                if (aprobador_3_id) customFields.aprobador_3 = aprobador_3_id;

                const aprobador_4_id = aprobadoresAsignados.aprobador_4 ? await getAprobadorId(aprobadoresAsignados.aprobador_4) : null;
                if (aprobador_4_id) customFields.aprobador_4 = aprobador_4_id;

                const aprobador_5_id = aprobadoresAsignados.aprobador_5 ? await getAprobadorId(aprobadoresAsignados.aprobador_5) : null;
                if (aprobador_5_id) customFields.aprobador_5 = aprobador_5_id;

                const aprobador_6_id = aprobadoresAsignados.aprobador_6 ? await getAprobadorId(aprobadoresAsignados.aprobador_6) : null;
                if (aprobador_6_id) customFields.aprobador_6 = aprobador_6_id;

                const requestObject = {
                    "email": "tom@outerspace.com",
                    "quantity": 1,
                    "custom_fields": customFields
                };

                console.log(requestObject);
                aprobadores_accordeon.style.display = "block";

            } else if (tipo_de_nota_de_credito === 'administrativa') {
                // Captura de datos de administrativa
                let centro_de_costo = document.getElementById("centro_costo_administrativa").value;
                let cliente = document.getElementById("cliente-administrativa").value;
                let agrup_bise = document.getElementById("bise-administrativa").value;
                let lob = document.getElementById("lob-administrativa").value;
                let division = document.getElementById("division-administrativa").value;
                let folio_dte = document.getElementById("folio-dte-administrativa").value;
                let rut = document.getElementById("rut_administrativa").value;
                let nombre = document.getElementById("nombre_folio_administrativa").value;
                let monto_neto = document.getElementById("monto_neto_administrativa").value;
                let fecha_emision = document.getElementById("fecha_emision_administrativa").value;
                let monto = document.getElementById("monto").value;
                let motivo = document.getElementById("motivo-administrativa").value;
                let detalle_otro_motivo = document.getElementById("detalle-motivo-administrativa").value;
                let aprobadores_list = document.getElementById("aprobadores-ul");
                let aprobadores_accordeon = document.getElementById("aprobadores-list");

                // Asignar aprobadores
                const aprobadoresAsignados = asignarAprobadores(monto_neto, aprobadores);


                agregarAprobadoresAListaHTML(aprobadoresAsignados, aprobadores_list);


                // Crear el objeto de campos personalizados dinámicamente
                const customFields = {
                    "tipo_de_nota_de_credito": tipo_de_nota_de_credito,
                    "centro_de_costo": centro_de_costo,
                    "cliente": cliente,
                    "agrup_bise": agrup_bise,
                    "lob": lob,
                    "division": division,
                    "folio_dte": folio_dte,
                    "rut": rut,
                    "nombre": nombre,
                    "monto_neto": monto_neto,
                    "fecha_emision": fecha_emision,
                    "monto": monto,
                    "motivo": motivo
                };

                if (detalle_otro_motivo) customFields.detalle_otro_motivo = detalle_otro_motivo;
                // Obtener los IDs de los aprobadores y agregarlos si existen
                const aprobador_1_id = await getAprobadorId(aprobadoresAsignados.aprobador_1);
                if (aprobador_1_id) customFields.aprobador_1 = aprobador_1_id;

                const aprobador_2_id = aprobadoresAsignados.aprobador_2 ? await getAprobadorId(aprobadoresAsignados.aprobador_2) : null;
                if (aprobador_2_id) customFields.aprobador_2 = aprobador_2_id;

                const aprobador_3_id = aprobadoresAsignados.aprobador_3 ? await getAprobadorId(aprobadoresAsignados.aprobador_3) : null;
                if (aprobador_3_id) customFields.aprobador_3 = aprobador_3_id;

                const aprobador_4_id = aprobadoresAsignados.aprobador_4 ? await getAprobadorId(aprobadoresAsignados.aprobador_4) : null;
                if (aprobador_4_id) customFields.aprobador_4 = aprobador_4_id;

                const aprobador_5_id = aprobadoresAsignados.aprobador_5 ? await getAprobadorId(aprobadoresAsignados.aprobador_5) : null;
                if (aprobador_5_id) customFields.aprobador_5 = aprobador_5_id;

                const aprobador_6_id = aprobadoresAsignados.aprobador_6 ? await getAprobadorId(aprobadoresAsignados.aprobador_6) : null;
                if (aprobador_6_id) customFields.aprobador_6 = aprobador_6_id;

                const requestObject = {
                    "email": "tom@outerspace.com",
                    "quantity": 1,
                    "custom_fields": customFields
                };

                console.log(requestObject);
                aprobadores_accordeon.style.display = "block";
            }
        }

    </script>

</body>

</html>