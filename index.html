<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<style>
    body {
        margin: 10rem;
    }

    .inputs-section {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    fw-form-control {
        margin-top: -1rem;
    }
</style>

<body>
    <div class="modal-element">
        <div class="modal-toolbar">
            <div class="modal-title"></div>
            <div class="close-btn"></div>
        </div>
        <div class="modal-body">

            <div id="static-form-container">
                <fw-form id="fw-static-form">

                    <fw-select label="Tipo Nota de Crédito" id="tipo-nota-credito" required="true" value="1"
                        placeholder="Tipo nota de Crédito">

                        <fw-select-option value="administrativa">Administrativa</fw-select-option>
                        <fw-select-option value="operacional">Operacional</fw-select-option>
                    </fw-select>

                    <div id="form-administrativa" class="form-administrativa">
                        <div class="section-1">
                            <div class="first-row">
                                <fw-select label="Centro de costo" id="centro_costo_administrativa" required="true"
                                    value="1" placeholder="Centro de costo">

                                    <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                    <fw-select-option value="operacional">Operacional</fw-select-option>
                                </fw-select>
                            </div>
                            <div class="inputs-section">
                                <fw-form-control type="TEXT" name="nombre" placeholder="Nombre" required label="Nombre"
                                    id="nombre_administrativa"></fw-form-control>
                                <fw-form-control type="TEXT" name="lob" placeholder="LOB" required label="LOB"
                                    id="lob_administrativa"></fw-form-control>
                                <fw-form-control type="TEXT" name="cliente" placeholder="Cliente" required
                                    label="Cliente" id="cliente_administrativa"></fw-form-control>
                                <fw-form-control type="TEXT" name="division" placeholder="Division" required
                                    label="Division" id="division_administrativa"></fw-form-control>
                                <fw-form-control type="TEXT" name="agrupbise" placeholder="Bise" required
                                    label="Agrup BISE" id="bise_administrativa"></fw-form-control>
                            </div>
                        </div>

                        <div class="section-2">
                            <div class="first-row">
                                <fw-select label="Folio DTE" id="folio_dte_administrativa" required="true" value="1"
                                    placeholder="Folio DTE">

                                    <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                    <fw-select-option value="operacional">Operacional</fw-select-option>
                                </fw-select>
                            </div>

                            <div class="inputs-section">
                                <fw-form-control type="TEXT" name="rut" placeholder="Rut" required label="Rut"
                                    id="rut_administrativa"></fw-form-control>

                                <fw-form-control type="TEXT" name="monto_neto" placeholder="Monto Neto" required
                                    label="Monto Neto" id="monto_neto_administrativa"></fw-form-control>

                                <fw-form-control type="TEXT" name="nombre" placeholder="Nombre" required label="Nombre"
                                    id="nombre_folio_administrativa"></fw-form-control>

                                <fw-form-control type="TEXT" name="fecha_emision" placeholder="Fecha Emision" required
                                    label="Fecha Emision" id="fecha_emision_administrativa"></fw-form-control>
                            </div>



                        </div>

                        <div class="section-3">
                            <fw-select label="Motivo" id="motivo" required="true" value="1" placeholder="Motivo"
                                hint-text="Seleccione Folio DTE">

                                <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                <fw-select-option value="operacional">Operacional</fw-select-option>
                            </fw-select>
                            <fw-form-control type="TEXT" name="detalleMotivo" placeholder="Detalle otro Motivo" required
                                label="Detalle Motivo" id="detalleMotivo"></fw-form-control>
                        </div>

                    </div>



                    <div id="form-operacional" class="form-operacional" style="display: none;">
                        <div class="tipo-de-venta">
                            <fw-select label="Tipo de venta" id="tipo_venta_operacional" required="true" value="1"
                                placeholder="Tipo de venta">

                                <fw-select-option value="venta-credito">Por venta Crédito</fw-select-option>
                                <fw-select-option value="venta-contado">Por venta Contado</fw-select-option>
                            </fw-select>
                        </div>
                        <div class="section-1">
                            <div class="first-row">
                                <fw-input type="NUMBER" name="centro_costo_operacional" label="Centro de Costo"
                                    placeholder="Centro de Costo" id="centro_costo_operacional"></fw-input>
                                <!-- <fw-select label="Centro de costo" id="centro_costo_operacional" required="true"
                                    value="1" placeholder="Centro de costo">

                                    <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                    <fw-select-option value="operacional">Operacional</fw-select-option>
                                </fw-select> -->
                            </div>
                            <div class="inputs-section">
                                <fw-form-control type="TEXT" name="nombre-cc-operacional" placeholder="Nombre" required
                                    label="Nombre" id="nombre-cc-operacional"></fw-form-control>
                                <fw-form-control type="TEXT" name="lob-operacional" placeholder="LOB" required
                                    label="LOB" id="lob-operacional"></fw-form-control>
                                <fw-form-control type="TEXT" name="cliente-operacional" placeholder="Cliente" required
                                    label="Cliente" id="cliente-operacional"></fw-form-control>
                                <fw-form-control type="TEXT" name="division-operacional" placeholder="Division" required
                                    label="Division" id="division-operacional"></fw-form-control>
                                <fw-form-control type="TEXT" name="bise-operacional" placeholder="Bise" required
                                    label="Agrup BISE" id="bise-operacional"></fw-form-control>
                            </div>
                        </div>

                        <div class="section-2">
                            <div class="first-row">
                                <fw-select label="Folio DTE" id="folio_dte_administrativa" required="true" value="1"
                                    placeholder="Folio DTE">

                                    <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                    <fw-select-option value="operacional">Operacional</fw-select-option>
                                </fw-select>
                            </div>

                            <div class="inputs-section">
                                <fw-form-control type="TEXT" name="rut" placeholder="Rut" required label="Rut"
                                    id="rut_administrativa"></fw-form-control>

                                <fw-form-control type="TEXT" name="monto_neto" placeholder="Monto Neto" required
                                    label="Monto Neto" id="monto_neto_administrativa"></fw-form-control>

                                <fw-form-control type="TEXT" name="nombre" placeholder="Nombre" required label="Nombre"
                                    id="nombre_folio_administrativa"></fw-form-control>

                                <fw-form-control type="TEXT" name="fecha_emision" placeholder="Fecha Emision" required
                                    label="Fecha Emision" id="fecha_emision_administrativa"></fw-form-control>
                            </div>



                        </div>

                        <div id="section-operacional" class="section-operacional inputs-section">

                            <fw-select label="Tipo" id="tipo_administrativa" required="true" value="1"
                                placeholder="Tipo">

                                <fw-select-option value="nc-anulacion">Nota de crédito por Anulación</fw-select-option>
                                <fw-select-option value="nc-rebaja">Nota de crédito por Rebaja</fw-select-option>
                                <fw-select-option value="nc-correccion">Nota de crédito de Corrección</fw-select-option>
                                <fw-select-option value="nc-anula-debito">Anula Nota de Débito</fw-select-option>
                            </fw-select>



                            <fw-form-control type="TEXT" name="monto" placeholder="Monto" required label="Monto"
                                id="monto"></fw-form-control>

                        </div>

                        <div class="section-3">
                            <fw-select label="Motivo" id="motivo" required="true" value="1" placeholder="Motivo"
                                hint-text="Seleccione Folio DTE">

                                <fw-select-option value="administrativa">Administrativa</fw-select-option>
                                <fw-select-option value="operacional">Operacional</fw-select-option>
                            </fw-select>
                            <fw-form-control type="TEXT" name="detalleMotivo" placeholder="Detalle otro Motivo" required
                                label="Detalle Motivo" id="detalleMotivo"></fw-form-control>
                        </div>

                    </div>



                </fw-form>



                <fw-button id="submit-static-form">Buscar Aprobadores </fw-button>
                <fw-button id="reset-static-form">Cancelar</fw-button>
            </div>
        </div>
        <script type="module"
            src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>


        <script>
            //listener de primer select tipo nota crédito
            document.addEventListener('DOMContentLoaded', () => {
                const optionSelect = document.getElementById("tipo-nota-credito");
                optionSelect.addEventListener('fwChange', (e) => {
                    console.log(e.detail.value);
                    if (e.detail.value === 'operacional') {
                        const formOperacional = document.getElementById("form-operacional");
                        formOperacional.style.display = "block";
                        const formAdministrativa = document.getElementById("form-administrativa");
                        formAdministrativa.style.display = "none";
                    }
                    else if (e.detail.value === 'administrativa') {
                        const formAdministrativa = document.getElementById("form-administrativa");
                        formAdministrativa.style.display = "block";
                        const formOperacional = document.getElementById("form-operacional");
                        formOperacional.style.display = "none";
                    }
                });

                // TO DO: AGREGAR EVENT LISTENER AL cambiar numero de cc    
                const inputCentroCostoOperacional = document.getElementById("centro_costo_operacional");
                let debounceTimeout;

                inputCentroCostoOperacional.addEventListener('input', (e) => {
                    clearTimeout(debounceTimeout);

                    debounceTimeout = setTimeout(async () => {  
                        const valorDigitado = e.target.value;
                        if (valorDigitado) {
                            try {
                                let response = await getCentroCosto(valorDigitado);
                                autoFillFieldsOperacional(response.records[0].data); 
                            } catch (error) {
                                console.error('Error al obtener centro de costo:', error);
                            }
                        }
                    }, 2000); 
                });

                const submitButton = document.getElementById("submit-static-form");
                submitButton.addEventListener('fwClick', async (e) => {
                    console.log("button Clicked");

                    const form = document.getElementById("fw-static-form");

                    const cc_input = document.getElementById("centro_costo_operacional");
                    console.log(cc_input.value);

                });

            });





            async function getCentroCosto(id_cc) {
                try {
                    const myHeaders = new Headers();
                    myHeaders.append("Authorization", "Basic cE1Felp6cmFMNm5XamVDcEt6SDpY");

                    const requestOptions = {
                        method: "GET",
                        headers: myHeaders,
                        redirect: "follow"
                    };

                    const response = await fetch(`https://aramark-hr.freshservice.com/api/v2/objects/21000039591/records?query=id_cc%20%3A%20%27${id_cc}%27`, requestOptions);

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    const result = await response.json();
                    console.log(result);
                    return result;

                } catch (error) {
                    console.error('Error fetching centro de costo:', error);
                }
            }


            function autoFillFieldsOperacional(response) {
                console.log(response);

                const form = document.getElementById("fw-static-form");
                form.setFieldValue(['nombre-cc-operacional'], response.name_cc);
                form.setFieldValue(['lob-operacional'], response.lob);
                form.setFieldValue(['cliente-operacional'], response.client);
                form.setFieldValue(['division-operacional'], response.division);
                form.setFieldValue(['bise-operacional'], response.agrup_bise);

            }




        </script>

</body>

</html>